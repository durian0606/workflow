<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>작업 관리</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      margin: 0;           /* 🆕 추가 */
      padding: 0;          /* 🆕 추가 */
      height: 100%;        /* 🆕 추가 */
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      height: 100%;        /* 🆕 추가 */
      overflow-x: hidden;
      overflow-y: auto;
      background: linear-gradient(135deg, #2a459c 0%, #5b7fd6 100%);
      touch-action: pan-y;
      margin: 0 !important;    /* 🆕 강제로 여백 제거 */
      padding: 0 !important;   /* 🆕 강제로 여백 제거 */
      position: relative;      /* 🆕 추가 */
    }
    
    /* 🆕 추가: 앱 컨테이너를 화면 전체에 꽉 차게 */
    .app-container {
      display: none !important;
      min-height: 100vh;
      height: 100vh;         /* 🆕 추가 */
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      position: fixed;       /* 🆕 추가: 화면에 고정 */
      top: 0;                /* 🆕 추가 */
      left: 0;               /* 🆕 추가 */
      right: 0;              /* 🆕 추가 */
      bottom: 0;             /* 🆕 추가 */
      overflow-y: auto;      /* 🆕 추가: 스크롤 가능하게 */
    }
    
    .app-container.active {
      display: flex !important;
      flex-direction: column;
    }

    /* 로그인 화면 */
    .login-container {
      display: flex !important;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      position: fixed;       /* 🆕 추가 */
      top: 0;                /* 🆕 추가 */
      left: 0;               /* 🆕 추가 */
      right: 0;              /* 🆕 추가 */
      bottom: 0;             /* 🆕 추가 */
      margin: 0;             /* 🆕 추가 */
      padding: 0;            /* 🆕 추가 */
    }
    
    .app-container {
      display: none !important;
      min-height: 100vh;
      background: #f5f7fa;
      margin: 0;           /* 🆕 추가 */
      padding: 0;          /* 🆕 추가 */
    }
    
    .app-container.active {
      display: flex !important;
      flex-direction: column;
      margin: 0;           /* 🆕 추가 */
      padding: 0;          /* 🆕 추가 */
    }
    
    /* 🆕 추가: 헤더의 상단 여백 제거 */
    .app-header {
      background: linear-gradient(135deg, #2a459c 0%, #5b7fd6 100%);
      color: white;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      margin-top: 0;       /* 🆕 추가 */
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
    }

    .login-title {
      font-size: 28px;
      font-weight: 600;
      color: #2a459c;
      margin-bottom: 30px;
      text-align: center;
    }

    .user-list-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
      text-align: center;
    }

    .user-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .user-card {
      padding: 20px;
      background: #f5f7fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-card:hover {
      background: #2a459c;
      color: white;
      border-color: #2a459c;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(42, 69, 156, 0.3);
    }

    .user-card-avatar {
      width: 50px;
      height: 50px;
      background: rgba(42, 69, 156, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 20px;
      margin: 0 auto 10px;
      color: #2a459c;
    }

    .user-card:hover .user-card-avatar {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .user-card-name {
      font-weight: 500;
      font-size: 15px;
    }

    .admin-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e0e0e0;
    }

    .admin-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .admin-input:focus {
      outline: none;
      border-color: #2a459c;
    }

    .admin-btn {
      width: 100%;
      padding: 12px;
      background: #2a459c;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .admin-btn:hover {
      background: #5b7fd6;
    }

/* 🆕 로그인 화면 추가 스타일 */
    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .input-hint {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
    }

    .input-hint.success {
      color: #4caf50;
    }

    .input-hint.error {
      color: #f44336;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      color: #999;
      font-size: 13px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #e0e0e0;
    }

    .divider span {
      padding: 0 16px;
    }

    .secondary-btn {
      width: 100%;
      padding: 12px;
      background: white;
      color: #2a459c;
      border: 2px solid #2a459c;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .secondary-btn:hover {
      background: #f5f7fa;
    }

    .back-btn {
      background: #f5f7fa;
      border: none;
      color: #666;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #e8eef3;
    }

    .company-info-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #e0e0e0;
    }

    .company-badge-icon {
      font-size: 18px;
    }

    .company-badge-name {
      font-size: 14px;
      font-weight: 600;
      color: #2a459c;
    }

/* 🆕 자동 로그인 체크박스 */
    .auto-login-container {
      margin: 16px 0 20px 0;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .auto-login-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #2a459c;
    }

    .checkbox-text {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .checkbox-label:hover .checkbox-text {
      color: #2a459c;
    }
    
    .app-header {
      background: linear-gradient(135deg, #2a459c 0%, #5b7fd6 100%);
      color: white;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .header-row-1 {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-row-2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
    }

    .header-info {
      display: flex;
      flex-direction: column;
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
    }

    .user-name {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .left-panel {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .date-display {
      font-size: 15px;
      font-weight: 600;
      color: white;
      flex: 1;
    }

    .nav-buttons {
      display: flex;
      gap: 6px;
    }

    .nav-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .task-input-container {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .task-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .form-row {
      display: flex;
      gap: 10px;
    }

    .task-input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border 0.2s;
    }

    .task-input:focus {
      outline: none;
      border-color: #2a459c;
    }

    .site-select-btn {
      background: #f5f7fa;
      border: 2px solid #e0e0e0;
      color: #333;
      padding: 14px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .site-select-btn:hover {
      background: #e8eef3;
      border-color: #2a459c;
    }

    .add-btn {
      background: #2a459c;
      border: none;
      color: white;
      padding: 14px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .add-btn:hover {
      background: #5b7fd6;
    }

    .task-container {
      background: white;
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }

    .task-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-bottom: 20px;
    }

    .task-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      align-items: center;  /* 세로 중앙 정렬 */
      gap: 10px;
      transition: all 0.2s;
      position: relative;
      cursor: grab;
      overflow: hidden;
    }
    
    /* 🆕 카드 본문 영역 (왼쪽) */
    .task-card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;  /* flex 자식의 텍스트 오버플로우 방지 */
    }

    /* 🆕 다른 회사 정보 영역 (가운데) */
    .other-companies-section {
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex-shrink: 0;
      margin: 0 4px;
      align-self: center;  /* 세로 중앙 정렬 */
    }
    
    /* 🆕 다른 회사 뱃지 - 상하 배치로 변경 */
    .other-company-badge {
      display: flex;
      flex-direction: column;  /* 🟢 상하 배치 */
      align-items: flex-start;  /* 🟢 왼쪽 정렬 */
      gap: 2px;  /* 🟢 줄 간격 줄임 */
      background: #fff3e0;
      border: 1px solid #ffb74d;
      padding: 3px 6px;  /* 🟢 패딩 조정 */
      border-radius: 4px;
      font-size: 9px;
      color: #f57c00;
      font-weight: 500;
    }
    
    /* 🟢 회사명 라인 */
    .other-company-name-line {
      display: flex;
      align-items: center;
    }
       
    .other-company-name {
      font-weight: 600;
      white-space: nowrap;
    }
    
    /* 🟢 담당자 라인 */
    .other-company-assignee-line {
      display: flex;
      align-items: center;
      padding-left: 8px;  /* 🟢 들여쓰기 유지 (아이콘 제거로 12px → 8px) */
    }
    
    .other-company-assignee {
      font-size: 10px;
      opacity: 0.9;
      white-space: nowrap;
    }
    
    /* 담당자 선택 영역 (오른쪽) */
    .person-select-container {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
      align-self: center;  /* 세로 중앙 정렬 */
    }

    .task-card:active {
      cursor: grabbing;
    }

    .task-card:hover {
      border-color: #2a459c;
      box-shadow: 0 2px 8px rgba(42, 69, 156, 0.15);
    }

    .task-card.dragging {
      opacity: 0.5;
    }

    .task-card.drag-over {
      border-color: #5b7fd6;
      background: #f0f9f9;
    }

    /* 드래그 중일 때만 스크롤 방지 */
    body.dragging-active {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    /* 번호와 체크박스를 감싸는 컨테이너 */
    .number-check-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .order-number {
      background: #2a459c;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 11px;
      flex-shrink: 0;
    }
    
    .task-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #2a459c;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .task-checkbox:hover {
      background: #e8f4f5;
      border-width: 3px;
    }

    /* 🟢 수정 후 */
    .task-card.completed .task-checkbox {
      background: #2a459c;
      position: relative;
      cursor: pointer;  /* 🆕 추가 */
      transition: all 0.2s;  /* 🆕 추가 */
    }
    
    .task-card.completed .task-checkbox::after {
      content: '✓';
      position: absolute;
      color: white;
      font-weight: bold;
      font-size: 12px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* 🆕 완료된 체크박스 호버 효과 */
    .task-card.completed .task-checkbox:hover {
      background: #5b7fd6;  /* 밝은 파란색으로 변경 */
      border-color: #5b7fd6;
      transform: scale(1.1);  /* 살짝 커짐 */
    }
    
    /* 🆕 완료된 체크박스 클릭 효과 */
    .task-card.completed .task-checkbox:active {
      transform: scale(0.95);  /* 클릭 시 살짝 작아짐 */
    }

    /* 🆕 모바일에서 터치 영역 확대 */
    @media (max-width: 768px) {
      .task-card.completed .task-checkbox {
        width: 24px;
        height: 24px;
        min-width: 44px;  /* iOS 권장 터치 영역 */
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .task-card.completed .task-checkbox::after {
        font-size: 14px;
      }
    }
    
    .task-card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      line-height: 1.3;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
      color: #999;
    }

    .task-card.my-task {
      border-left: 4px solid #2a459c;
      background: linear-gradient(to right, rgba(42, 69, 156, 0.03), white);
    }

    .person-select-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .select-wrapper {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .select-label {
      font-size: 9px;
      color: #999;
      font-weight: 500;
    }

    .assignee-select {
      padding: 3px 6px;
      border: 1.5px solid #e0e0e0;
      border-radius: 6px;
      font-size: 11px;
      background: white;
      cursor: pointer;
      transition: border 0.2s;
    }

    .assignee-select:hover {
      border-color: #2a459c;
    }

    .assignee-select:disabled {
      background: #f5f7fa;
      cursor: not-allowed;
    }

    .action-btn {
      background: #ffe0e0;
      border: none;
      width: 50px;  /* 32px에서 50px로 증가 */
      height: 100%;  /* 카드 높이에 맞춤 */
      border-radius: 0;  /* 둥근 모서리 제거 */
      border-top-right-radius: 8px;  /* 오른쪽만 둥글게 */
      border-bottom-right-radius: 8px;
      cursor: pointer;
      font-size: 16px;  /* 14px에서 16px로 증가 */
      transition: all 0.3s ease;
      flex-shrink: 0;
      position: absolute;
      right: -50px;  /* 🆕 버튼 너비만큼 숨김 */
      top: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* PC에서는 항상 표시 */
    @media (min-width: 769px) {
      .action-btn {
        position: static;  /* PC에서는 절대 위치 해제 */
        display: flex;
        width: 32px;
        height: 32px;
        border-radius: 6px;  /* PC에서는 원래 스타일 유지 */
        font-size: 14px;
      }
    }
    
    /* 모바일에서 슬라이드 시 표시 */
    @media (max-width: 768px) {
      .task-card {
        position: relative;
        overflow: hidden;  /* 🆕 변경: visible에서 hidden으로 */
        transition: transform 0.3s ease;  /* 🆕 부드러운 슬라이드 */
      }
      
      .task-card.swiped-left {
        transform: translateX(-50px);  /* 🆕 카드를 왼쪽으로 이동 */
      }
      
      .task-card.swiped-left .action-btn {
        right: 0;  /* 🆕 버튼이 오른쪽에 딱 붙음 */
      }
      
      .action-btn {
        display: flex;
      }
    }
    
    .action-btn:active {
      background: #ffb3b3;  /* 🆕 터치 시 더 진한 색 */
    }

    .action-btn:hover {
      background: #ffcccc;
      transform: scale(1.1);
    }

    .map-section {
      background: white;
      margin: 20px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-height: 500px;
    }

    .map-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .map-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .route-info {
      font-size: 12px;
      color: #2a459c;
      font-weight: 600;
      background: rgba(42, 69, 156, 0.1);
      padding: 4px 10px;
      border-radius: 4px;
    }

    .section-header {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .section-header:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .section-header.my-work {
      color: #2a459c;
    }

    .section-toggle {
      margin-right: 8px;
      font-size: 14px;
      transition: transform 0.3s;
    }

    .section-header.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .task-grid.collapsed {
      display: none;
    }

    .section-divider {
      margin: 20px 0;
      border-bottom: 1px solid #e8e8e8;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* 지도 */
    #map {
      width: 100%;
      height: 450px;
      border-radius: 8px;
    }

    .map-controls {
      display: flex;
      gap: 10px;
    }

    .map-btn {
      background: #2a459c;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .map-btn:hover {
      background: #5b7fd6;
    }

    .map-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* 모달 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
    }

    /* 작업 타임라인 모달 */
    .timeline-item {
      padding: 16px;
      background: #f5f7fa;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .timeline-item.active {
      background: #e8f4f5;
      border-left: 4px solid #2a459c;
    }

    .timeline-work {
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }

    .timeline-date {
      font-size: 13px;
      color: #666;
    }

    /* 현장 선택 모달 */
    .site-list {
      list-style: none;
      margin-bottom: 20px;
    }

    .site-item {
      padding: 14px;
      background: #f5f7fa;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .site-item:hover {
      background: #e8eef3;
    }

    .site-item-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .site-item-name {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .site-item-address {
      font-size: 12px;
      color: #666;
    }

    /* 🆕 현장 아이템 버튼 컨테이너 */
    .site-item-actions {
      display: flex;
      gap: 6px;
    }
    
    /* 🆕 현장 수정 버튼 */
    .site-item-edit {
      background: #e3f2fd;
      border: none;
      color: #1976d2;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .site-item-edit:hover {
      background: #bbdefb;
    }
    
    /* 현장 삭제 버튼 */
    .site-item-delete {
      background: #ffe0e0;
      border: none;
      color: #d13438;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .site-item-delete:hover {
      background: #ffcdd2;
    }

    /* 완료 기한 선택 모달 */
    .deadline-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .deadline-modal.active {
      display: flex;
    }

    .deadline-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .deadline-modal-header {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }

    .deadline-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .deadline-option {
      padding: 14px 16px;
      background: #f5f7fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      font-size: 15px;
    }

    .deadline-option:hover {
      background: #2a459c;
      color: white;
      border-color: #2a459c;
    }

    .deadline-option-label {
      font-weight: 500;
      display: block;
    }

    .deadline-option-date {
      font-size: 13px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .deadline-custom {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .deadline-date-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .deadline-date-input:focus {
      outline: none;
      border-color: #2a459c;
    }

    .deadline-confirm-btn {
      padding: 12px 24px;
      background: #2a459c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .deadline-confirm-btn:hover {
      background: #5b7fd6;
    }

    .deadline-label-container {
      display: inline-flex;  /* flex에서 inline-flex로 변경 */
      align-items: center;
      gap: 4px;  /* 6px에서 4px로 축소 */
      margin-top: 4px;
      cursor: pointer;
      width: fit-content;  /* 추가: 컨텐츠 크기만큼만 */
    }
    
    .deadline-label-text {
      font-size: 10px;  /* 11px에서 10px로 축소 */
      color: #666;
      white-space: nowrap;  /* 추가: 줄바꿈 방지 */
    }
    
    .deadline-date-tag {
      display: inline-block;
      padding: 2px 6px;  /* 8px에서 6px로 축소 */
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 3px;  /* 4px에서 3px로 축소 */
      font-size: 10px;  /* 11px에서 10px로 축소 */
      font-weight: 500;
      white-space: nowrap;  /* 추가: 줄바꿈 방지 */
    }

    .add-site-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .site-list-section {
      margin-top: 20px;
    }

    .site-list-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      font-weight: 600;
    }

    /* 기한 초과 작업 스타일 */
    .task-card.overdue {
      border-left: 4px solid #f44336;
      background: #ffebee;
    }

    .task-card.overdue .task-title {
      color: #d32f2f;
      font-weight: 600;
    }

    .deadline-date-tag.overdue {
      background: #f44336;
      color: white;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .overdue-warning {
      display: inline-block;
      margin-left: 6px;
      padding: 2px 6px;
      background: #f44336;
      color: white;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      animation: pulse 1.5s infinite;
    }

    .date-label {
      font-size: 11px;
      color: #666;
      margin-right: 4px;
    }

    .test-date-label {
      display: inline-block;
      padding: 2px 6px;  /* 8px에서 6px로 축소 */
      background: #fff3e0;
      color: #f57c00;
      border-radius: 3px;
      font-size: 10px;  /* 11px에서 10px로 축소 */
      font-weight: 500;
      white-space: nowrap;  /* 추가: 줄바꿈 방지 */
    }

    /* 로딩 오버레이 */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 20000;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #2a459c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      font-size: 14px;
      color: #666;
    }

    @media (max-width: 768px) {
      .number-check-container {
        gap: 4px;
      }
      
      .task-checkbox {
        width: 20px;
        height: 20px;
      }
          
      .task-container {
        max-height: 400px;
      }

      .map-section {
        min-height: 350px;
        margin: 10px;
        padding: 15px;
      }

      #map {
        height: 300px;
      }

      /* 완료 섹션 스크롤바 스타일 */
      .task-grid {
        scrollbar-width: thin;
        scrollbar-color: #2a459c #f5f7fa;
      }

      .task-grid::-webkit-scrollbar {
        width: 8px;
      }

      .task-grid::-webkit-scrollbar-track {
        background: #f5f7fa;
        border-radius: 4px;
      }

      .task-grid::-webkit-scrollbar-thumb {
        background: #2a459c;
        border-radius: 4px;
      }

      .task-grid::-webkit-scrollbar-thumb:hover {
        background: #5b7fd6;
      }
    }

    /* ========================================
       🆕 메뉴 시스템 (헤더 밖으로 분리)
       ======================================== */
    
    /* 메뉴 버튼 */
    .menu-btn {
      background: rgba(255, 255, 255, 0.2);  /* 🆕 투명도 살짝 낮춤 */
      border: none;                          /* 🆕 외곽선 완전 제거 */
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    /* 🆕 호버 효과도 외곽선 없이 */
    .menu-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border: none;                          /* 🆕 추가 */
      transform: scale(1.05);
    }
    
    .menu-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    
    .menu-btn:hover::before {
      width: 100px;
      height: 100px;
    }
        
    .menu-btn:active {
      transform: scale(0.95);
    }
    
    .menu-hamburger {
      display: flex;
      flex-direction: column;
      gap: 5px;
      position: relative;
      z-index: 1;
    }
    
    .menu-line {
      width: 24px;
      height: 3px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    
    .menu-btn:hover .menu-line:nth-child(1) {
      transform: translateX(-3px);
    }
    
    .menu-btn:hover .menu-line:nth-child(2) {
      transform: translateX(0);
    }
    
    .menu-btn:hover .menu-line:nth-child(3) {
      transform: translateX(3px);
    }
    
    .menu-btn.active .menu-line:nth-child(1) {
      transform: translateY(8px) rotate(45deg);
    }
    
    .menu-btn.active .menu-line:nth-child(2) {
      opacity: 0;
    }
    
    .menu-btn.active .menu-line:nth-child(3) {
      transform: translateY(-8px) rotate(-45deg);
    }
    
    /* 메뉴 드롭다운 */
    .menu-dropdown {
      position: fixed;
      top: 80px;
      right: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-20px) scale(0.9);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 10001;
      overflow: hidden;
    }
    
    .menu-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .menu-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(42, 69, 156, 0.08), transparent);
      transition: width 0.3s ease;
    }
    
    .menu-item:hover::before {
      width: 100%;
    }
    
    .menu-item:hover {
      background: #f8f9fa;
    }
    
    .menu-item:active {
      background: #e9ecef;
    }
    
    .menu-item-icon {
      font-size: 22px;
      width: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    
    .menu-item:hover .menu-item-icon {
      transform: scale(1.1);
    }
    
    .menu-item-text {
      font-size: 15px;
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    
    .menu-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 4px 0;
    }
    
    .menu-item-danger {
      color: #d32f2f;
    }
    
    .menu-item-danger .menu-item-text {
      color: #d32f2f;
    }
    
    .menu-item-danger::before {
      background: linear-gradient(90deg, rgba(211, 47, 47, 0.08), transparent);
    }
    
    .menu-item-danger:hover {
      background: #ffebee;
    }
    
    .menu-item-danger:active {
      background: #ffcdd2;
    }
    
    /* 메뉴 오버레이 (배경 어둡게) */
    .menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .menu-overlay.active {
      display: block;
      opacity: 1;
    }
    
    /* 모바일 최적화 */
    @media (max-width: 768px) {
      .menu-btn {
        width: 44px;
        height: 44px;
      }
    
      .menu-line {
        width: 22px;
        height: 2.5px;
      }
    
      .menu-dropdown {
        top: 70px;
        right: 8px;
        min-width: 180px;
      }
    
      .menu-item {
        padding: 14px 16px;
      }
    
      .menu-item-icon {
        font-size: 20px;
        width: 26px;
      }
    
      .menu-item-text {
        font-size: 14px;
      }
    }
    
    /* ========================================
       사용 설명서 모달 스타일
       ======================================== */
    
    .guide-modal-content {
      max-width: 700px;
      max-height: 85vh;
    }
    
    .guide-content {
      padding: 8px 0;
    }
    
    .guide-section {
      margin-bottom: 32px;
    }
    
    .guide-section-title {
      font-size: 18px;
      font-weight: 700;
      color: #2a459c;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e3f2fd;
    }
    
    .guide-step {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      align-items: flex-start;
    }
    
    .guide-step-number {
      background: #2a459c;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .guide-step-content {
      flex: 1;
    }
    
    .guide-step-content h4 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .guide-step-content p {
      font-size: 14px;
      line-height: 1.6;
      color: #666;
      margin-bottom: 8px;
    }
    
    .guide-list {
      margin: 12px 0;
      padding-left: 20px;
    }
    
    .guide-list li {
      font-size: 14px;
      color: #666;
      margin-bottom: 6px;
      line-height: 1.5;
    }
    
    .guide-tip {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      padding: 10px 12px;
      margin-top: 12px;
      font-size: 13px;
      color: #1565C0;
      border-radius: 4px;
    }
    
    .guide-warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 10px 12px;
      margin-top: 12px;
      font-size: 13px;
      color: #e65100;
      border-radius: 4px;
    }
    
    .guide-tips-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .guide-tip-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      background: #f5f7fa;
      padding: 12px;
      border-radius: 8px;
    }
    
    .tip-emoji {
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .guide-tip-item span:last-child {
      font-size: 14px;
      line-height: 1.6;
      color: #666;
    }
    
    .guide-contact {
      background: #f5f7fa;
      padding: 20px;
      border-radius: 8px;
    }
    
    .guide-contact p {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    
    .contact-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .contact-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #333;
    }
    
    .contact-icon {
      font-size: 18px;
      width: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* 모바일 최적화 */
    @media (max-width: 768px) {
      .guide-modal-content {
        width: 95%;
        max-height: 90vh;
      }
    
      .guide-section-title {
        font-size: 16px;
      }
    
      .guide-step {
        gap: 12px;
      }
    
      .guide-step-number {
        width: 28px;
        height: 28px;
        font-size: 13px;
      }
    
      .guide-step-content h4 {
        font-size: 15px;
      }
    
      .guide-step-content p {
        font-size: 13px;
      }
    }
      
      .guide-step-content h4 {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }
      
      .guide-step-content p {
        font-size: 14px;
        line-height: 1.6;
        color: #666;
        margin-bottom: 8px;
      }
      
      .guide-list {
        margin: 12px 0;
        padding-left: 20px;
      }
      
      .guide-list li {
        font-size: 14px;
        color: #666;
        margin-bottom: 6px;
        line-height: 1.5;
      }
      
      .guide-tip {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 10px 12px;
        margin-top: 12px;
        font-size: 13px;
        color: #1565C0;
        border-radius: 4px;
      }
      
      .guide-warning {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 10px 12px;
        margin-top: 12px;
        font-size: 13px;
        color: #e65100;
        border-radius: 4px;
      }
      
      .guide-tips-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .guide-tip-item {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        background: #f5f7fa;
        padding: 12px;
        border-radius: 8px;
      }
      
      .tip-emoji {
        font-size: 20px;
        flex-shrink: 0;
      }
      
      .guide-tip-item span:last-child {
        font-size: 14px;
        line-height: 1.6;
        color: #666;
      }
      
      .guide-contact {
        background: #f5f7fa;
        padding: 20px;
        border-radius: 8px;
      }
      
      .guide-contact p {
        font-size: 14px;
        color: #666;
        margin-bottom: 16px;
        line-height: 1.6;
      }
      
      .contact-info {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .contact-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #333;
      }
      
      .contact-icon {
        font-size: 18px;
        width: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* 모바일 최적화 */
      @media (max-width: 768px) {
        .menu-dropdown {
          right: 8px;
          min-width: 160px;
        }
        
        .guide-modal-content {
          width: 95%;
          max-height: 90vh;
        }
      
        .guide-section-title {
          font-size: 16px;
        }
      
        .guide-step {
          gap: 12px;
        }
      
        .guide-step-number {
          width: 28px;
          height: 28px;
          font-size: 13px;
        }
      
        .guide-step-content h4 {
          font-size: 15px;
        }
      
        .guide-step-content p {
          font-size: 13px;
        }
        
        /* 🆕 다른 회사 정보 뱃지 */
        .other-company-badge {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          background: #fff3e0;
          border: 1px solid #ffb74d;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 10px;
          color: #f57c00;
          margin-top: 4px;
          font-weight: 500;
        }
        
        .other-company-text {
          white-space: nowrap;
        }
        .other-company-badge {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          background: #fff3e0;
          border: 1px solid #ffb74d;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 10px;
          color: #f57c00;
          margin-top: 4px;
          font-weight: 500;
        }
        
        .other-company-text {
          white-space: nowrap;
        }
      }
    
  </style>
</head>

<body>
  <!-- 로딩 오버레이 -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">경로를 계산하는 중...</div>
    </div>
  </div>

  <!-- 로그인 화면 -->
  <div class="login-container" id="loginContainer">
    <!-- Step 1: 회사 로그인 -->
<!-- Step 1: 회사 로그인 -->
    <div class="login-box" id="companyLoginStep">
      <h1 class="login-title">🏢 회사 로그인</h1>
      
      <div class="input-group">
        <label class="input-label">회사 ID</label>
        <input type="text" class="admin-input" id="companyIdInput" placeholder="회사 ID 입력" autocomplete="username">
        <div class="input-hint">회사 관리자에게 문의하세요</div>
      </div>
      
      <div class="input-group">
        <label class="input-label">비밀번호</label>
        <input type="password" class="admin-input" id="companyPasswordInput" placeholder="비밀번호 입력" autocomplete="current-password">
      </div>
      
      <div class="auto-login-container">
        <label class="checkbox-label">
          <input type="checkbox" class="auto-login-checkbox" id="autoLoginCheckbox">
          <span class="checkbox-text">자동 로그인</span>
        </label>
      </div>
      
      <button class="admin-btn" onclick="loginCompany()">로그인</button>
      
      <div class="divider">
        <span>또는</span>
      </div>
      
      <button class="secondary-btn" onclick="showCreateCompanyStep()">새 회사 만들기</button>
    </div>

    <!-- Step 2: 새 회사 만들기 -->
    <div class="login-box" id="createCompanyStep" style="display: none;">
      <h1 class="login-title">🏢 새 회사 만들기</h1>
      <button class="back-btn" onclick="backToCompanyLogin()">← 뒤로</button>
      
      <!-- 회사명 입력란 -->
      <div class="input-group">
        <label class="input-label">회사명</label>
        <input type="text" class="admin-input" id="newCompanyNameInput" placeholder="예: (주)건설회사" autocomplete="off">
        <div class="input-hint">실제 회사 이름을 입력하세요</div>
      </div>
      
      <!-- 🆕 관리자 이름 입력란 추가 -->
      <div class="input-group">
        <label class="input-label">관리자 이름</label>
        <input type="text" class="admin-input" id="newAdminNameInput" placeholder="예: 홍길동" autocomplete="off">
        <div class="input-hint">회사 관리자의 이름을 입력하세요</div>
      </div>
      
      <div class="input-group">
        <label class="input-label">회사 ID</label>
        <input type="text" class="admin-input" id="newCompanyIdInput" placeholder="영문+숫자 조합" autocomplete="off">
        <div class="input-hint" id="companyIdHint">영문, 숫자 조합 (4-20자)</div>
      </div>
      
      <div class="input-group">
        <label class="input-label">비밀번호</label>
        <input type="password" class="admin-input" id="newCompanyPasswordInput" placeholder="비밀번호 설정" autocomplete="new-password">
        <div class="input-hint">최소 4자 이상</div>
      </div>
      
      <div class="input-group">
        <label class="input-label">비밀번호 확인</label>
        <input type="password" class="admin-input" id="confirmPasswordInput" placeholder="비밀번호 재입력" autocomplete="new-password">
      </div>
      
      <button class="admin-btn" onclick="createCompany()">회사 만들기</button>
    </div>

    <!-- Step 3: 사용자 선택 -->
    <div class="login-box" id="userSelectStep" style="display: none;">
      <h1 class="login-title">작업 관리</h1>
      <div class="company-info-badge">
        <span class="company-badge-icon">🏢</span>
        <span class="company-badge-name" id="companyIdDisplay"></span>
      </div>
      <p class="user-list-title">사용자를 선택하세요</p>
      <div class="user-grid" id="userGrid"></div>

      <div class="admin-section">
        <input type="text" class="admin-input" id="newUserInput" placeholder="새 사용자 추가">
        <button class="admin-btn" onclick="addNewUser()">추가</button>
      </div>
    </div>
  </div>

  <!-- 메인 앱 -->
  <div class="app-container" id="appContainer">
    <div class="app-header">
      <!-- 첫 번째 줄: 로고, 사용자 정보, 현장, 로그아웃 -->
      <div class="header-row-1">
        <div class="header-left">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="header-info">
            <div class="app-title">작업 관리</div>
            <div class="user-name" id="headerUserName"></div>
          </div>
        </div>
        <div class="header-right">
          <button class="menu-btn" onclick="toggleMenu()">
            <span class="menu-hamburger">
              <span class="menu-line"></span>
              <span class="menu-line"></span>
              <span class="menu-line"></span>
            </span>
          </button>
        </div>
      </div>

      <!-- 두 번째 줄: 날짜 네비게이션 -->
      <div class="header-row-2">
        <div class="date-display" id="dateDisplay"></div>
        <div class="nav-buttons">
          <button class="nav-btn" onclick="goToToday()">오늘</button>
          <button class="nav-btn" onclick="changeDate(-1)">◀</button>
          <button class="nav-btn" onclick="changeDate(1)">▶</button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="left-panel">
        <div class="task-input-container">
          <div class="task-form">
            <div class="form-row">
              <input type="text" class="task-input" id="siteInput" placeholder="현장명">
              <button class="site-select-btn" onclick="toggleSiteSelectModal()">📋 선택</button>
            </div>
            <div class="form-row">
              <input type="text" class="task-input" id="workInput" placeholder="작업 내용 입력">
              <button class="add-btn" onclick="addWork()">+ 추가</button>
            </div>
          </div>
        </div>

        <div class="task-container" id="taskContainer"></div>

        <!-- 지도 섹션 -->
        <div class="map-section">
          <div class="map-section-header">
            <h3 class="map-section-title">
              🚗 이동 경로
              <span class="route-info" id="routeInfo" style="display: none;"></span>
            </h3>
            <div class="map-controls">
              <button class="map-btn" id="routeBtn" onclick="showRouteFromCurrentLocation()">경로 표시</button>
            </div>
          </div>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="menu-overlay" id="menuOverlay"></div>
  
  <div class="menu-dropdown" id="menuDropdown">
    <div class="menu-item" onclick="toggleSiteModal(); toggleMenu();">
      <span class="menu-item-icon">📍</span>
      <span class="menu-item-text">현장 추가/수정</span>
    </div>
    <div class="menu-item" onclick="toggleGuideModal(); toggleMenu();">
      <span class="menu-item-icon">📖</span>
      <span class="menu-item-text">사용 설명서</span>
    </div>
    
    <!-- 🆕 관리자 전용 섹션 (JavaScript로 동적 표시) -->
    <div id="adminMenuSection" style="display: none;">
      <div class="menu-divider"></div>
      <div class="menu-item" style="background: #fff8e1; pointer-events: none;">
        <span class="menu-item-icon">👑</span>
        <span class="menu-item-text" style="font-weight: 600; color: #F57C00;">관리 메뉴</span>
      </div>
      <div class="menu-item" onclick="toggleCompanyCodeModal(); toggleMenu();">
        <span class="menu-item-icon">🔑</span>
        <span class="menu-item-text">회사 코드 확인</span>
      </div>
      <div class="menu-item" onclick="toggleStaffManageModal(); toggleMenu();">
        <span class="menu-item-icon">👥</span>
        <span class="menu-item-text">직원 관리</span>
      </div>
      <div class="menu-item" onclick="toggleCompanyInfoModal(); toggleMenu();">
        <span class="menu-item-icon">🏢</span>
        <span class="menu-item-text">회사 정보 수정</span>
      </div>
      <div class="menu-item" onclick="toggleTransferAdminModal(); toggleMenu();">
        <span class="menu-item-icon">🔄</span>
        <span class="menu-item-text">관리자 권한 이전</span>
      </div>
    </div>
    
    <div class="menu-divider"></div>
    <div class="menu-item menu-item-danger" onclick="deleteCompany()">
      <span class="menu-item-icon">⚠️</span>
      <span class="menu-item-text">회사 탈퇴</span>
    </div>
    <div class="menu-item menu-item-danger" onclick="logout()">
      <span class="menu-item-icon">🚪</span>
      <span class="menu-item-text">로그아웃</span>
    </div>
  </div>
  <!-- 작업 타임라인 모달 -->
  <div class="modal-overlay" id="timelineModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="timelineTitle"></h3>
        <button class="close-btn" onclick="closeTimelineModal()">×</button>
      </div>
      <div id="timelineContent"></div>
    </div>
  </div>

  <!-- 현장 관리 모달 -->
  <div class="modal-overlay" id="siteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="siteModalTitle">현장 추가</h3>
        <button class="close-btn" onclick="toggleSiteModal()">×</button>
      </div>
  
      <div class="add-site-form">
        <input type="text" class="task-input" id="newSiteName" placeholder="현장명 입력">
        <input type="text" class="task-input" id="newSiteAddress" placeholder="주소 입력">
        <button class="add-btn" id="saveSiteBtn" onclick="saveSite()">저장</button>
        <!-- 🆕 수정 모드 취소 버튼 -->
        <button class="secondary-btn" id="cancelEditBtn" onclick="cancelEditSite()" style="display: none;">취소</button>
      </div>
  
      <div class="site-list-section">
        <h4 class="site-list-title">저장된 현장 목록</h4>
        <ul class="site-list" id="siteList"></ul>
      </div>
    </div>
  </div>

  <!-- 완료 기한 선택 모달 -->
  <div class="deadline-modal" id="deadlineModal">
    <div class="deadline-modal-content">
      <div class="deadline-modal-header">완료 기한 선택</div>
      <div class="deadline-options">
        <div class="deadline-option" onclick="selectDeadline('today')">
          <span class="deadline-option-label">오늘</span>
          <span class="deadline-option-date" id="todayDate"></span>
        </div>
        <div class="deadline-option" onclick="selectDeadline('tomorrow')">
          <span class="deadline-option-label">내일</span>
          <span class="deadline-option-date" id="tomorrowDate"></span>
        </div>
        <div class="deadline-option" onclick="selectDeadline('thisWeek')">
          <span class="deadline-option-label">이번주 중 (금요일)</span>
          <span class="deadline-option-date" id="thisWeekDate"></span>
        </div>
        <div class="deadline-custom">
          <input type="date" class="deadline-date-input" id="customDeadlineInput">
          <button class="deadline-confirm-btn" onclick="selectDeadline('custom')">확인</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 현장 선택 모달 -->
  <div class="modal-overlay" id="siteSelectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">현장 선택</h3>
        <button class="close-btn" onclick="toggleSiteSelectModal()">×</button>
      </div>
      <ul class="site-list" id="siteSelectList"></ul>
    </div>
  </div>
  
  <!-- 🆕 직원 관리 모달 -->
  <div class="modal-overlay" id="staffManageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">👥 직원 관리</h3>
        <button class="close-btn" onclick="toggleStaffManageModal()">×</button>
      </div>
      
      <div style="padding: 10px 0;">
        <div style="margin-bottom: 20px;">
          <h4 style="font-size: 14px; color: #666; margin-bottom: 12px; font-weight: 600;">
            현재 직원 목록 (<span id="staffCount">0</span>명)
          </h4>
          <ul class="site-list" id="staffList"></ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 🆕 회사 정보 수정 모달 -->
  <div class="modal-overlay" id="companyInfoModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🏢 회사 정보 수정</h3>
        <button class="close-btn" onclick="toggleCompanyInfoModal()">×</button>
      </div>
      
      <div style="padding: 10px 0;">
        <div class="input-group">
          <label class="input-label">회사명</label>
          <input type="text" class="admin-input" id="editCompanyName" placeholder="회사명">
        </div>
        
        <div class="input-group">
          <label class="input-label">현재 비밀번호</label>
          <input type="password" class="admin-input" id="currentPasswordForEdit" placeholder="현재 비밀번호">
          <div class="input-hint">변경하려면 현재 비밀번호를 입력하세요</div>
        </div>
        
        <div class="input-group">
          <label class="input-label">새 비밀번호 (선택)</label>
          <input type="password" class="admin-input" id="newPasswordForEdit" placeholder="변경할 비밀번호">
          <div class="input-hint">변경하지 않으려면 비워두세요</div>
        </div>
        
        <div class="input-group">
          <label class="input-label">새 비밀번호 확인</label>
          <input type="password" class="admin-input" id="confirmNewPassword" placeholder="비밀번호 재입력">
        </div>
        
        <button class="admin-btn" onclick="saveCompanyInfo()">💾 저장</button>
      </div>
    </div>
  </div>
  
  <!-- 🆕 관리자 권한 이전 모달 -->
  <div class="modal-overlay" id="transferAdminModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🔄 관리자 권한 이전</h3>
        <button class="close-btn" onclick="toggleTransferAdminModal()">×</button>
      </div>
      
      <div style="padding: 10px 0;">
        <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
          <p style="font-size: 13px; color: #e65100; line-height: 1.6;">
            ⚠️ <strong>주의:</strong> 관리자 권한을 이전하면 본인은 일반 직원이 됩니다. 이 작업은 되돌릴 수 없습니다.
          </p>
        </div>
        
        <div class="input-group">
          <label class="input-label">새 관리자 선택</label>
          <select class="admin-input" id="newAdminSelect">
            <option value="">선택하세요</option>
          </select>
        </div>
        
        <div class="input-group">
          <label class="input-label">비밀번호 확인</label>
          <input type="password" class="admin-input" id="passwordForTransfer" placeholder="현재 비밀번호">
          <div class="input-hint">권한 이전을 확인하기 위해 비밀번호를 입력하세요</div>
        </div>
        
        <button class="admin-btn" onclick="transferAdmin()" style="background: #ff9800;">
          🔄 권한 이전
        </button>
      </div>
    </div>
  </div>
  
<!-- 🆕 사용 설명서 모달 -->
<div class="modal-overlay" id="guideModal">
  <div class="modal-content guide-modal-content">
    <div class="modal-header">
      <h3 class="modal-title">📖 사용 설명서</h3>
      <button class="close-btn" onclick="toggleGuideModal()">×</button>
    </div>
    
    <div class="guide-content">
      <!-- 1. 시작하기 -->
      <div class="guide-section">
        <h3 class="guide-section-title">🚀 1. 시작하기</h3>
        <div class="guide-step">
          <div class="guide-step-number">1</div>
          <div class="guide-step-content">
            <h4>사용자 선택</h4>
            <p>로그인 화면에서 본인의 이름을 선택하세요. 새 사용자는 하단에서 추가할 수 있습니다.</p>
          </div>
        </div>
      </div>

      <!-- 2. 현장 관리 -->
      <div class="guide-section">
        <h3 class="guide-section-title">🏗️ 2. 현장 관리</h3>
        <div class="guide-step">
          <div class="guide-step-number">2</div>
          <div class="guide-step-content">
            <h4>현장 추가하기</h4>
            <p>① 우측 상단 메뉴(☰) → "현장 추가" 클릭<br>
               ② 현장명과 주소 입력<br>
               ③ 저장 버튼 클릭</p>
            <div class="guide-tip">💡 주소는 경로 표시 기능에 사용되므로 정확히 입력하세요.</div>
          </div>
        </div>
      </div>

      <!-- 3. 작업 추가 -->
      <div class="guide-section">
        <h3 class="guide-section-title">✍️ 3. 작업 추가</h3>
        <div class="guide-step">
          <div class="guide-step-number">3</div>
          <div class="guide-step-content">
            <h4>일반 작업 추가</h4>
            <p>① 현장명 입력 (또는 "선택" 버튼으로 등록된 현장 선택)<br>
               ② 작업 내용 입력 (예: 배근, 거푸집, 콘크리트 타설 등)<br>
               ③ "추가" 버튼 클릭</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="guide-step-number">4</div>
          <div class="guide-step-content">
            <h4>시험 작업 추가 (자동 일정 생성)</h4>
            <p>작업 내용에 "시험"을 입력하면 자동으로 관련 일정이 생성됩니다:</p>
            <ul class="guide-list">
              <li>시험 당일</li>
              <li>캡핑 (영업일 +1일)</li>
              <li>탈형 (영업일 +2일)</li>
              <li>7일 강도 시험 (+7일)</li>
              <li>28일 강도 시험 (+28일)</li>
            </ul>
            <div class="guide-tip">💡 시험 관련 작업은 작업등록일자를 클릭하면 전체 타임라인을 볼 수 있습니다.</div>
          </div>
        </div>
      </div>

      <!-- 4. 작업 관리 -->
      <div class="guide-section">
        <h3 class="guide-section-title">📋 4. 작업 관리</h3>
        <div class="guide-step">
          <div class="guide-step-number">5</div>
          <div class="guide-step-content">
            <h4>작업 순서 변경</h4>
            <p><strong>PC:</strong> 작업 카드를 드래그하여 위아래로 이동<br>
               <strong>모바일:</strong> 작업 카드를 길게 누르고 상하로 드래그</p>
            <div class="guide-tip">💡 "내 작업 진행 중" 섹션에서만 순서 변경 가능</div>
          </div>
        </div>
        <div class="guide-step">
          <div class="guide-step-number">6</div>
          <div class="guide-step-content">
            <h4>작업 완료 체크</h4>
            <p>작업 카드 왼쪽의 체크박스를 클릭하면 완료 처리됩니다.<br>
               완료된 작업의 체크박스를 다시 클릭하면 진행중으로 되돌아갑니다.</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="guide-step-number">7</div>
          <div class="guide-step-content">
            <h4>작업 삭제</h4>
            <p><strong>PC:</strong> 작업 카드 우측의 🗑️ 버튼 클릭<br>
               <strong>모바일:</strong> 작업 카드를 왼쪽으로 슬라이드하면 삭제 버튼 표시</p>
            <div class="guide-warning">⚠️ 시험 작업 삭제 시 관련된 모든 작업(캡핑, 탈형 등)이 함께 삭제됩니다.</div>
          </div>
        </div>
        <div class="guide-step">
          <div class="guide-step-number">8</div>
          <div class="guide-step-content">
            <h4>담당자 지정</h4>
            <p>작업 카드의 담당자 선택 드롭다운에서 담당자를 변경할 수 있습니다.</p>
          </div>
        </div>
        <div class="guide-step">
          <div class="guide-step-number">9</div>
          <div class="guide-step-content">
            <h4>완료 기한 설정</h4>
            <p>작업 카드의 "완료 기한" 날짜를 클릭하면 기한을 변경할 수 있습니다:<br>
               • 오늘<br>
               • 내일<br>
               • 이번주 중 (금요일)<br>
               • 직접 날짜 선택</p>
            <div class="guide-warning">⚠️ 기한이 지난 작업은 빨간색으로 표시되며 "기한초과" 뱃지가 표시됩니다.</div>
          </div>
        </div>
      </div>

      <!-- 5. 날짜 네비게이션 -->
      <div class="guide-section">
        <h3 class="guide-section-title">📅 5. 날짜 네비게이션</h3>
        <div class="guide-step">
          <div class="guide-step-number">10</div>
          <div class="guide-step-content">
            <h4>날짜 이동</h4>
            <p>헤더의 날짜 표시 옆 버튼으로 날짜를 이동할 수 있습니다:<br>
               • <strong>오늘:</strong> 오늘 날짜로 이동<br>
               • <strong>◀:</strong> 하루 전으로<br>
               • <strong>▶:</strong> 하루 후로</p>
            <div class="guide-tip">💡 선택한 날짜 이전의 미완료 작업도 함께 표시됩니다.</div>
          </div>
        </div>
      </div>

      <!-- 6. 경로 표시 -->
      <div class="guide-section">
        <h3 class="guide-section-title">🗺️ 6. 이동 경로 표시</h3>
        <div class="guide-step">
          <div class="guide-step-number">11</div>
          <div class="guide-step-content">
            <h4>경로 확인하기</h4>
            <p>① 지도 섹션의 "경로 표시" 버튼 클릭<br>
               ② 위치 권한 허용<br>
               ③ 현재 위치에서 출발하여 작업 순서대로 현장을 방문하는 최적 경로가 표시됩니다.</p>
            <div class="guide-tip">💡 경로는 작업 순서에 따라 자동으로 계산되며, 총 거리와 소요 시간이 표시됩니다.</div>
          </div>
        </div>
      </div>

      <!-- 7. 팁과 요령 -->
      <div class="guide-section">
        <h3 class="guide-section-title">💡 7. 유용한 팁</h3>
        <div class="guide-tips-list">
          <div class="guide-tip-item">
            <span class="tip-emoji">✅</span>
            <span>아침에 출근하면 작업 순서를 먼저 정리하세요. 이동 경로가 자동으로 최적화됩니다.</span>
          </div>
          <div class="guide-tip-item">
            <span class="tip-emoji">📍</span>
            <span>자주 방문하는 현장은 미리 등록해두면 빠르게 선택할 수 있습니다.</span>
          </div>
          <div class="guide-tip-item">
            <span class="tip-emoji">📋</span>
            <span>섹션 헤더를 클릭하면 접거나 펼칠 수 있어 화면을 효율적으로 사용할 수 있습니다.</span>
          </div>
          <div class="guide-tip-item">
            <span class="tip-emoji">🔔</span>
            <span>시험 작업은 자동으로 일정이 생성되므로 일일이 입력할 필요가 없습니다.</span>
          </div>
          <div class="guide-tip-item">
            <span class="tip-emoji">👥</span>
            <span>팀 작업도 한눈에 볼 수 있어 업무 분담과 협업이 쉽습니다.</span>
          </div>
        </div>
      </div>

      <!-- 8. 문의하기 -->
      <div class="guide-section">
        <h3 class="guide-section-title">📞 8. 문의하기</h3>
        <div class="guide-contact">
          <p>사용 중 문의사항이나 개선 제안이 있으시면 언제든 연락주세요.</p>
          <div class="contact-info">
            <div class="contact-item">
              <span class="contact-icon">📧</span>
              <span>이메일: support@example.com</span>
            </div>
            <div class="contact-item">
              <span class="contact-icon">💬</span>
              <span>카카오톡: @작업관리앱</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>  
  <!-- Kakao Map API -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=edfe0792f24f219880fc608009d59a0f&libraries=services"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAMv0BmH24fyd0F8CUTkSYSXMlvbcnUXU4",
      authDomain: "work-todo-6ab7f.firebaseapp.com",
      databaseURL: "https://work-todo-6ab7f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "work-todo-6ab7f",
      storageBucket: "work-todo-6ab7f.firebasestorage.app",
      messagingSenderId: "263893669261",
      appId: "1:263893669261:web:bdce10bec177ff1f67d9c4"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    window.db = database;
    window.dbRef = ref;
    window.dbSet = set;
    window.dbPush = push;
    window.dbOnValue = onValue;
    window.dbUpdate = update;
    window.dbRemove = remove;
    window.firebaseReady = true;
    console.log('✅ Firebase initialized');
  </script>
  
  <script>
    // 🆕 문자열 유사도 계산 함수 (Levenshtein distance 기반)
    function calculateSimilarity(str1, str2) {
      if (!str1 || !str2) return 0;
      
      // 정규화: 소문자 변환, 공백 제거
      str1 = str1.toLowerCase().replace(/\s+/g, '');
      str2 = str2.toLowerCase().replace(/\s+/g, '');
      
      if (str1 === str2) return 100;
      
      const len1 = str1.length;
      const len2 = str2.length;
      
      if (len1 === 0 || len2 === 0) return 0;
      
      // Levenshtein distance 계산
      const matrix = [];
      for (let i = 0; i <= len1; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,      // 삭제
            matrix[i][j - 1] + 1,      // 삽입
            matrix[i - 1][j - 1] + cost // 대체
          );
        }
      }
      
      const distance = matrix[len1][len2];
      const maxLen = Math.max(len1, len2);
      const similarity = ((maxLen - distance) / maxLen) * 100;
      
      return similarity;
    }
    
    // 🆕 현장 유사도 비교 함수 (현장명 + 주소)
    function areSitesSimilar(site1Name, site1Address, site2Name, site2Address) {
      // 현장명과 주소를 합쳐서 비교
      const full1 = (site1Name || '') + ' ' + (site1Address || '');
      const full2 = (site2Name || '') + ' ' + (site2Address || '');
      
      const similarity = calculateSimilarity(full1, full2);
      
      console.log(`🔍 현장 비교: "${site1Name}" vs "${site2Name}" | 유사도: ${similarity.toFixed(1)}%`);
      
      return similarity >= 80; // 80% 이상 유사하면 같은 현장
    }

    let currentDate = new Date();
    let works = {};
    let assignees = [];
    let sites = {};
    let allCompaniesWorks = {};
    let currentUser = null;
    let currentCompanyId = null;
    let currentUserId = null;  // 🆕 현재 사용자 ID
    let isAdmin = false;  // 🆕 관리자 여부
    let companyInfo = null;  // 🆕 회사 정보
    let map = null;
    let currentMarker = null;
    let currentLocationMarker = null;
    let routeMarkers = [];
    let routeLine = null;
    let currentPosition = null;
    let isRouteDisplayed = false;
    let draggedElement = null;
    let draggedWorkId = null;
    let originalOrder = [];
    let isDraggingNow = false;
    let selectedCard = null; // 선택된 카드 추적
    let currentEditingSiteId = null;
    let sectionStates = {
      myActive: true,
      teamActive: true,
      completed: true
    };
    
    function waitForFirebase() {
      if (window.firebaseReady) {
        initApp();
      } else {
        setTimeout(waitForFirebase, 100);
      }
    }
    
    function initApp() {
      console.log('✅ 앱 초기화 시작');
      // 🆕 무조건 로그인 화면 먼저 표시
      document.getElementById('companyLoginStep').style.display = 'block';
      checkSavedCompany();
    }
    
    // 🆕 저장된 회사 정보 확인 (자동 로그인)
    function checkSavedCompany() {
      const autoLogin = localStorage.getItem('autoLogin') === 'true';
      const savedCompanyId = localStorage.getItem('savedCompanyId');
      const savedPassword = localStorage.getItem('savedPassword');
      
      if (autoLogin && savedCompanyId && savedPassword) {
        console.log('🔐 자동 로그인 시도...');
        
        // 자동 로그인 시도
        const companyRef = window.dbRef(window.db, `companies/${savedCompanyId}/info`);
        window.dbOnValue(companyRef, (snapshot) => {
          const companyInfo = snapshot.val();
          
          if (companyInfo && companyInfo.password === savedPassword) {
            console.log('✅ 자동 로그인 성공!');
            currentCompanyId = savedCompanyId;
            showUserSelectStep();
          } else {
            console.log('❌ 자동 로그인 실패 - 로그인 화면 표시');
            // 저장된 정보가 잘못되었으면 초기화
            clearAutoLogin();
            showLoginScreen();
          }
        }, { onlyOnce: true });
      } else {
        // 자동 로그인 정보 없음
        showLoginScreen();
      }
    }

    // 🆕 로그인 화면 표시
    function showLoginScreen() {
      document.getElementById('companyLoginStep').style.display = 'block';
      
      // 저장된 정보가 있으면 입력란에 채우기 (자동 로그인 체크 안 된 경우)
      const savedCompanyId = localStorage.getItem('savedCompanyId');
      if (savedCompanyId) {
        document.getElementById('companyIdInput').value = savedCompanyId;
      }
    }

    // 🆕 자동 로그인 정보 초기화
    function clearAutoLogin() {
      localStorage.removeItem('autoLogin');
      localStorage.removeItem('savedCompanyId');
      localStorage.removeItem('savedPassword');
    }
    
        // 🆕 회사 ID 중복 확인
        async function checkCompanyIdAvailability(companyId) {
          return new Promise((resolve) => {
            const companiesRef = window.dbRef(window.db, 'companies');
            window.dbOnValue(companiesRef, (snapshot) => {
              const companies = snapshot.val();
              
              if (!companies) {
                resolve(true); // 첫 회사면 사용 가능
                return;
              }
              
              // 회사 ID가 이미 존재하는지 확인
              const exists = Object.keys(companies).some(id => id === companyId);
              resolve(!exists);
            }, { onlyOnce: true });
          });
        }
    
        // 🆕 회사 로그인
    // 🆕 회사 로그인
    window.loginCompany = async function() {
      const companyId = document.getElementById('companyIdInput').value.trim();
      const password = document.getElementById('companyPasswordInput').value;
      const autoLogin = document.getElementById('autoLoginCheckbox').checked;
      
      if (!companyId) {
        alert('회사 ID를 입력하세요.');
        return;
      }
      
      if (!password) {
        alert('비밀번호를 입력하세요.');
        return;
      }
      
      // Firebase에서 회사 정보 확인
      const companyRef = window.dbRef(window.db, `companies/${companyId}/info`);
      window.dbOnValue(companyRef, (snapshot) => {
        const companyInfo = snapshot.val();
        
        if (!companyInfo) {
          alert('존재하지 않는 회사 ID입니다.');
          return;
        }
        
        if (companyInfo.password !== password) {
          alert('비밀번호가 일치하지 않습니다.');
          return;
        }
        
        // 로그인 성공
        currentCompanyId = companyId;
        
        // 자동 로그인 체크 여부에 따라 저장
        if (autoLogin) {
          localStorage.setItem('autoLogin', 'true');
          localStorage.setItem('savedCompanyId', companyId);
          localStorage.setItem('savedPassword', password);
          console.log('✅ 자동 로그인 정보 저장됨');
        } else {
          // 체크 안 했으면 자동 로그인 정보 삭제 (회사 ID만 저장)
          localStorage.removeItem('autoLogin');
          localStorage.setItem('savedCompanyId', companyId);
          localStorage.removeItem('savedPassword');
          console.log('ℹ️ 회사 ID만 저장됨');
        }
        
        // 사용자 선택 화면으로 이동
        showUserSelectStep();
      }, { onlyOnce: true });
    };
    
        // 🆕 새 회사 만들기 화면 표시
        window.showCreateCompanyStep = function() {
          document.getElementById('companyLoginStep').style.display = 'none';
          document.getElementById('createCompanyStep').style.display = 'block';
        };

        // 🆕 로그인 화면으로 돌아가기
        window.backToCompanyLogin = function() {
          document.getElementById('createCompanyStep').style.display = 'none';
          document.getElementById('companyLoginStep').style.display = 'block';
          
          // 입력 필드 초기화
          document.getElementById('newCompanyNameInput').value = '';
          document.getElementById('newAdminNameInput').value = '';  // 🆕 추가
          document.getElementById('newCompanyIdInput').value = '';
          document.getElementById('newCompanyPasswordInput').value = '';
          document.getElementById('confirmPasswordInput').value = '';
          document.getElementById('companyIdHint').textContent = '영문, 숫자 조합 (4-20자)';
          document.getElementById('companyIdHint').className = 'input-hint';
        };
    
        // 🆕 회사 ID 실시간 중복 확인
        let checkTimeout;
        document.addEventListener('DOMContentLoaded', function() {
          const companyIdInput = document.getElementById('newCompanyIdInput');
          if (companyIdInput) {
            companyIdInput.addEventListener('input', function() {
              clearTimeout(checkTimeout);
              const companyId = this.value.trim();
              const hint = document.getElementById('companyIdHint');
              
              if (!companyId) {
                hint.textContent = '영문, 숫자 조합 (4-20자)';
                hint.className = 'input-hint';
                return;
              }
              
              // 형식 검증
              const regex = /^[a-zA-Z0-9]{4,20}$/;
              if (!regex.test(companyId)) {
                hint.textContent = '❌ 영문, 숫자만 사용 가능 (4-20자)';
                hint.className = 'input-hint error';
                return;
              }
              
              hint.textContent = '확인 중...';
              hint.className = 'input-hint';
              
              // 중복 확인 (500ms 지연)
              checkTimeout = setTimeout(async () => {
                const available = await checkCompanyIdAvailability(companyId);
                if (available) {
                  hint.textContent = '✅ 사용 가능한 ID입니다';
                  hint.className = 'input-hint success';
                } else {
                  hint.textContent = '❌ 이미 사용 중인 ID입니다';
                  hint.className = 'input-hint error';
                }
              }, 500);
            });
          }
        });

        // 🆕 새 회사 만들기
        window.createCompany = async function() {
          const companyName = document.getElementById('newCompanyNameInput').value.trim();
          const companyId = document.getElementById('newCompanyIdInput').value.trim();
          const password = document.getElementById('newCompanyPasswordInput').value;
          const confirmPassword = document.getElementById('confirmPasswordInput').value;
          const adminName = document.getElementById('newAdminNameInput').value.trim();
          
          if (!companyName) {
            alert('회사명을 입력하세요.');
            return;
          }
          
          if (!companyId) {
            alert('회사 ID를 입력하세요.');
            return;
          }
          
          const regex = /^[a-zA-Z0-9]{4,20}$/;
          if (!regex.test(companyId)) {
            alert('회사 ID는 영문과 숫자 조합으로 4-20자여야 합니다.');
            return;
          }
          
          if (!password) {
            alert('비밀번호를 입력하세요.');
            return;
          }
          
          if (password.length < 4) {
            alert('비밀번호는 최소 4자 이상이어야 합니다.');
            return;
          }
          
          if (password !== confirmPassword) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
          }
          
          if (!adminName) {
            alert('관리자 이름을 입력하세요.');
            return;
          }
          
          const available = await checkCompanyIdAvailability(companyId);
          if (!available) {
            alert('이미 사용 중인 회사 ID입니다.');
            return;
          }
          
          try {
            // 1. 관리자 사용자 생성
            const assigneesRef = window.dbRef(window.db, `companies/${companyId}/assignees`);
            const newAdminRef = window.dbPush(assigneesRef);
            const adminId = newAdminRef.key;
            
            await window.dbSet(newAdminRef, {
              name: adminName,
              isAdmin: true,
              createdAt: new Date().toISOString()
            });
            
            // 2. 회사 정보 생성
            const companyInfoRef = window.dbRef(window.db, `companies/${companyId}/info`);
            await window.dbSet(companyInfoRef, {
              name: companyName,
              password: password,
              createdAt: new Date().toISOString(),
              adminId: adminId,
              companyCode: generateCompanyCode()
            });
            
            alert(`회사가 생성되었습니다!\n\n회사명: ${companyName}\n회사 ID: ${companyId}\n관리자: ${adminName}\n\n팀원들과 공유하세요.`);
            
            // 자동 로그인
            currentCompanyId = companyId;
            currentUser = adminName;
            currentUserId = adminId;
            isAdmin = true;
            
            localStorage.setItem('currentCompanyId', companyId);
            
            showMainApp();
            
          } catch (error) {
            console.error('❌ 회사 생성 중 오류:', error);
            alert('회사 생성 중 오류가 발생했습니다: ' + error.message);
          }
        };
        
        // 🆕 회사 코드 생성 함수 (6자리 랜덤)
        function generateCompanyCode() {
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let code = '';
          for (let i = 0; i < 6; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          return code;
        }
    
        // 🆕 사용자 선택 화면 표시
        function showUserSelectStep() {
          document.getElementById('companyLoginStep').style.display = 'none';
          document.getElementById('createCompanyStep').style.display = 'none';
          document.getElementById('userSelectStep').style.display = 'block';
          
          // 회사 ID 표시
          document.getElementById('companyIdDisplay').textContent = currentCompanyId;
          
          loadAssignees();
        }
    
    function initMap() {
      if (typeof kakao === 'undefined' || !kakao.maps) {
        console.error('카카오맵 API가 로드되지 않았습니다.');
        document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;text-align:center;padding:20px;">카카오맵을 불러오는 중입니다...</div>';
        setTimeout(() => {
          if (typeof kakao !== 'undefined' && kakao.maps) {
            initMap();
          }
        }, 1000);
        return;
      }
      try {
        const container = document.getElementById('map');
        const options = {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 3
        };
        map = new kakao.maps.Map(container, options);
        const mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
        const zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
        setTimeout(() => {
          map.relayout();
        }, 100);
        console.log('✅ 지도 초기화 성공!');
      } catch (error) {
        console.error('❌ 지도 초기화 실패:', error);
        document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;text-align:center;padding:20px;">지도를 불러올 수 없습니다.<br>페이지를 새로고침 해주세요.</div>';
      }
    }
    
    window.showRouteFromCurrentLocation = function() {
      console.log('🚀 경로 표시 시작');
      if (!map) {
        alert('지도가 초기화되지 않았습니다.');
        return;
      }
      
      const searchDate = currentDate.toISOString().split('T')[0];
      const myActiveWorks = [];
      Object.keys(works).forEach(workId => {
        const work = works[workId];
        if (work.completed) return;
        if (work.assignee !== currentUser) return;
        let shouldShow = false;
        if (work.work === '시험' || work.parentWorkId) {
          shouldShow = work.date === searchDate;
        } else {
          shouldShow = work.date <= searchDate;
        }
        if (shouldShow) {
          myActiveWorks.push(work);
        }
      });
      
      myActiveWorks.sort((a, b) => {
        const orderA = typeof a.order === 'number' ? a.order : 999;
        const orderB = typeof b.order === 'number' ? b.order : 999;
        if (orderA === orderB) {
          return a.id.localeCompare(b.id);
        }
        return orderA - orderB;
      });
      
      console.log('📋 내 작업 진행 중:', myActiveWorks.length, '개');
      if (myActiveWorks.length === 0) {
        alert('표시할 작업이 없습니다.');
        return;
      }
      
      if (navigator.geolocation) {
        document.getElementById('loadingOverlay').classList.add('active');
        document.getElementById('routeBtn').disabled = true;
        console.log('📍 현재 위치 요청 중...');
        
        const timeout = setTimeout(() => {
          document.getElementById('loadingOverlay').classList.remove('active');
          document.getElementById('routeBtn').disabled = false;
          alert('위치 정보를 가져오는데 시간이 너무 오래 걸립니다. 다시 시도해주세요.');
          console.error('❌ 위치 요청 타임아웃');
        }, 10000);
        
        navigator.geolocation.getCurrentPosition(
          function(position) {
            clearTimeout(timeout);
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            console.log('✅ 현재 위치:', lat, lng);
            currentPosition = new kakao.maps.LatLng(lat, lng);
            drawRouteFromCurrentLocation(currentPosition, myActiveWorks);
          },
          function(error) {
            clearTimeout(timeout);
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('routeBtn').disabled = false;
            let errorMsg = '위치 정보를 가져올 수 없습니다.\n\n';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMsg += '위치 권한이 거부되었습니다.\n브라우저 설정에서 위치 권한을 허용해주세요.';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMsg += '위치 정보를 사용할 수 없습니다.';
                break;
              case error.TIMEOUT:
                errorMsg += '위치 정보 요청 시간이 초과되었습니다.';
                break;
              default:
                errorMsg += '알 수 없는 오류가 발생했습니다.';
            }
            alert(errorMsg);
            console.error('❌ 위치 정보 에러:', error);
          }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        alert('이 브라우저는 위치 서비스를 지원하지 않습니다.');
      }
    };
    
    function drawRouteFromCurrentLocation(currentPos, myActiveWorks) {
      console.log('🗺️ 경로 그리기 시작');
      
      if (currentLocationMarker) {
        currentLocationMarker.setMap(null);
      }
      routeMarkers.forEach(marker => marker.setMap(null));
      routeMarkers = [];
      if (routeLine) {
        if (Array.isArray(routeLine)) {
          routeLine.forEach(line => line.setMap(null));
        } else {
          routeLine.setMap(null);
        }
        routeLine = null;
      }
      
      const uniqueSites = [];
      const siteNames = new Set();
      myActiveWorks.forEach(work => {
        if (!siteNames.has(work.site)) {
          uniqueSites.push(work.site);
          siteNames.add(work.site);
        }
      });
      console.log('🏗️ 고유 현장:', uniqueSites);
      
      const geocoder = new kakao.maps.services.Geocoder();
      const promises = [];
      const positions = [{
        coords: currentPos,
        siteName: '현재 위치',
        index: 0
      }];
      
      uniqueSites.forEach((siteName, index) => {
        const site = Object.values(sites).find(s => s.name === siteName);
        if (!site || !site.address) {
          console.warn(`⚠️ 현장 "${siteName}"의 주소 정보가 없습니다.`);
          return;
        }
        console.log(`📍 주소 검색: ${siteName} - ${site.address}`);
        const promise = new Promise((resolve) => {
          geocoder.addressSearch(site.address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
              positions.push({
                coords,
                siteName,
                index: index + 1
              });
              console.log(`✅ 좌표 변환 성공: ${siteName}`);
              resolve();
            } else {
              console.warn(`❌ 주소 검색 실패: ${site.address} (상태: ${status})`);
              resolve();
            }
          });
        });
        promises.push(promise);
      });
      
      Promise.all(promises).then(() => {
        console.log('📊 변환된 위치:', positions.length, '개');
        positions.sort((a, b) => a.index - b.index);
        if (positions.length < 2) {
          document.getElementById('loadingOverlay').classList.remove('active');
          document.getElementById('routeBtn').disabled = false;
          alert('경로를 표시할 현장의 주소를 찾을 수 없습니다.\n현장 관리에서 주소를 확인해주세요.');
          console.error('❌ 유효한 위치가 2개 미만');
          isRouteDisplayed = false;
          return;
        }

        getRealRoutes(positions).then(routeData => {
          console.log('🎨 마커 그리기 시작');

          const startMarkerContent = `
            <div style="position: relative;">
              <div style="
                background: #ff5722;
                color: white;
                border: 3px solid white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 18px;
                box-shadow: 0 3px 8px rgba(0,0,0,0.4);
              ">📍</div>
              <div style="
                position: absolute;
                top: -35px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                padding: 8px 12px;
                border-radius: 4px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                white-space: nowrap;
                font-size: 13px;
                font-weight: 600;
                color: #ff5722;
              ">🚩 출발</div>
            </div>
          `;
          currentLocationMarker = new kakao.maps.CustomOverlay({
            position: positions[0].coords,
            content: startMarkerContent,
            yAnchor: 1
          });
          currentLocationMarker.setMap(map);

          for (let i = 1; i < positions.length; i++) {
            const pos = positions[i];
            const markerContent = `
              <div style="position: relative;">
                <div style="
                  background: #2a459c;
                  color: white;
                  border: 3px solid white;
                  border-radius: 50%;
                  width: 35px;
                  height: 35px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-weight: bold;
                  font-size: 14px;
                  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                ">${i}</div>
                <div style="
                  position: absolute;
                  top: -35px;
                  left: 50%;
                  transform: translateX(-50%);
                  background: white;
                  padding: 8px 12px;
                  border-radius: 4px;
                  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                  white-space: nowrap;
                  font-size: 13px;
                  font-weight: 600;
                ">${i}. ${pos.siteName}</div>
              </div>
            `;
            const marker = new kakao.maps.CustomOverlay({
              position: pos.coords,
              content: markerContent,
              yAnchor: 1
            });
            marker.setMap(map);
            routeMarkers.push(marker);
          }

          console.log('✏️ 구간별 색상 경로선 그리기');
            
          const routeColors = [
            '#FF5722',
            '#2196F3',
            '#4CAF50',
            '#9C27B0',
            '#FF9800',
            '#00BCD4',
          ];
            
          routeLine = [];
            
          routeData.segments.forEach((segment, index) => {
            const color = routeColors[index % routeColors.length];
            const segmentLine = new kakao.maps.Polyline({
              path: segment.points,
              strokeWeight: 6,
              strokeColor: color,
              strokeOpacity: 0.8,
              strokeStyle: 'solid'
            });
            segmentLine.setMap(map);
            routeLine.push(segmentLine);
          });

          const bounds = new kakao.maps.LatLngBounds();
          routeData.allPoints.forEach(point => bounds.extend(point));
          map.setBounds(bounds);

          document.getElementById('loadingOverlay').classList.remove('active');
          document.getElementById('routeBtn').disabled = false;
          isRouteDisplayed = true;

          const totalDistance = (routeData.totalDistance / 1000).toFixed(1);
          const totalTime = Math.round(routeData.totalTime / 60);
          console.log(`✅ 경로 표시 완료 - 총 ${totalDistance}km, 약 ${totalTime}분`);
          
          // 거리와 시간을 레이블 옆에 표시
          const routeInfo = document.getElementById('routeInfo');
          routeInfo.textContent = `${totalDistance}km · ${totalTime}분`;
          routeInfo.style.display = 'inline-block';
          
        }).catch(error => {
          console.error('❌ 경로 계산 실패:', error);
          drawStraightRoute(positions);
        });
      }).catch(error => {
        console.error('❌ 경로 표시 중 에러:', error);
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('routeBtn').disabled = false;
        isRouteDisplayed = false;
        alert('경로를 표시하는 중 오류가 발생했습니다.');
      });
    }

    async function getRealRoutes(positions) {
      const PROXY_BASE = 'https://workflow-blush-five.vercel.app';
      
      const allPoints = [];
      const segments = [];
      let totalDistance = 0;
      let totalTime = 0;
    
      for (let i = 0; i < positions.length - 1; i++) {
        const segmentPoints = [];
        
        const origin = positions[i].coords;
        const destination = positions[i + 1].coords;
    
        const originStr = `${origin.getLng()},${origin.getLat()}`;
        const destStr = `${destination.getLng()},${destination.getLat()}`;
    
        const url = `${PROXY_BASE}/api/directions?origin=${encodeURIComponent(originStr)}&destination=${encodeURIComponent(destStr)}`;
    
        try {
          const resp = await fetch(url, { method: 'GET' });
          if (!resp.ok) throw new Error(`proxy ${resp.status}`);
    
          const data = await resp.json();
    
          if (!data.routes || data.routes.length === 0) {
            segmentPoints.push(origin);
            segmentPoints.push(destination);
          } else {
            const route = data.routes[0];
            const sections = route.sections || [];
    
            sections.forEach(section => {
              (section.roads || []).forEach(road => {
                const verts = road.vertexes || [];
                for (let v = 0; v < verts.length; v += 2) {
                  const lng = verts[v];
                  const lat = verts[v + 1];
                  if (typeof lat === 'number' && typeof lng === 'number') {
                    const point = new kakao.maps.LatLng(lat, lng);
                    segmentPoints.push(point);
                    allPoints.push(point);
                  }
                }
              });
            });
    
            if (route.summary) {
              totalDistance += route.summary.distance || 0;
              totalTime += route.summary.duration || 0;
            }
          }
        } catch (err) {
          console.error(`구간 ${i}-${i+1} 경로 요청 실패:`, err);
          segmentPoints.push(positions[i].coords);
          segmentPoints.push(positions[i + 1].coords);
          allPoints.push(positions[i].coords);
          allPoints.push(positions[i + 1].coords);
        }
        
        segments.push({
          from: positions[i].siteName,
          to: positions[i + 1].siteName,
          points: segmentPoints
        });
      }
    
      return {
        allPoints: allPoints,
        segments: segments,
        totalDistance,
        totalTime
      };
    }

    function drawStraightRoute(positions) {
      console.log('⚠️ 백업: 직선 경로로 표시');

      const startMarkerContent = `
        <div style="position: relative;">
          <div style="
            background: #ff5722;
            color: white;
            border: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
          ">📍</div>
          <div style="
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
            font-size: 13px;
            font-weight: 600;
            color: #ff5722;
          ">🚩 출발</div>
        </div>
      `;
      currentLocationMarker = new kakao.maps.CustomOverlay({
        position: positions[0].coords,
        content: startMarkerContent,
        yAnchor: 1
      });
      currentLocationMarker.setMap(map);

      for (let i = 1; i < positions.length; i++) {
        const pos = positions[i];
        const markerContent = `
          <div style="position: relative;">
            <div style="
              background: #2a459c;
              color: white;
              border: 3px solid white;
              border-radius: 50%;
              width: 35px;
              height: 35px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
              font-size: 14px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            ">${i}</div>
            <div style="
              position: absolute;
              top: -35px;
              left: 50%;
              transform: translateX(-50%);
              background: white;
              padding: 8px 12px;
              border-radius: 4px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
              white-space: nowrap;
              font-size: 13px;
              font-weight: 600;
            ">${i}. ${pos.siteName}</div>
          </div>
        `;
        const marker = new kakao.maps.CustomOverlay({
          position: pos.coords,
          content: markerContent,
          yAnchor: 1
        });
        marker.setMap(map);
        routeMarkers.push(marker);
      }

      const linePath = positions.map(pos => pos.coords);
      routeLine = new kakao.maps.Polyline({
        path: linePath,
        strokeWeight: 5,
        strokeColor: '#2a459c',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLine.setMap(map);

      const bounds = new kakao.maps.LatLngBounds();
      positions.forEach(pos => bounds.extend(pos.coords));
      map.setBounds(bounds);

      document.getElementById('loadingOverlay').classList.remove('active');
      document.getElementById('routeBtn').disabled = false;
      isRouteDisplayed = true;

      console.log(`✅ 직선 경로 표시 완료`);
    }

// 🆕 모든 회사의 작업 정보 로드 (다른 회사 현장 표시용)
    function loadAllCompaniesWorks() {
      const companiesRef = window.dbRef(window.db, 'companies');
      window.dbOnValue(companiesRef, (snapshot) => {
        const companies = snapshot.val() || {};
        allCompaniesWorks = {};
        
        Object.keys(companies).forEach(companyId => {
          allCompaniesWorks[companyId] = {
            name: companies[companyId].info?.name || companyId,
            works: companies[companyId].works || {},
            sites: companies[companyId].sites || {}  // 🆕 현장 정보도 포함
          };
        });
        
        // 데이터 로드 후 화면 갱신
        if (currentUser) {
          renderWorks();
        }
      });
    }
    
    function loadAssignees() {
      const assigneesRef = window.dbRef(window.db, `companies/${currentCompanyId}/assignees`);
      window.dbOnValue(assigneesRef, (snapshot) => {
        assignees = [];
        const data = snapshot.val();
        if (data) {
          Object.keys(data).forEach(key => {
            assignees.push({
              id: key,
              name: data[key].name,
              isAdmin: data[key].isAdmin || false  // 🆕 관리자 정보 추가
            });
          });
        }
        
        // 🆕 관리자를 맨 앞으로 정렬
        assignees.sort((a, b) => {
          if (a.isAdmin && !b.isAdmin) return -1;
          if (!a.isAdmin && b.isAdmin) return 1;
          return a.name.localeCompare(b.name);
        });
        
        renderUserGrid();
      });
    }
    
    function renderUserGrid() {
      const grid = document.getElementById('userGrid');
      if (!grid) {
        console.error('❌ userGrid 요소를 찾을 수 없습니다');
        return;
      }
      
      grid.innerHTML = '';
      
      console.log('👥 사용자 카드 렌더링:', assignees.length, '명');
      
      assignees.forEach((user, index) => {
        const card = document.createElement('div');
        card.className = 'user-card';
        
        // 🆕 관리자 카드 스타일 추가
        if (user.isAdmin) {
          card.style.background = 'linear-gradient(135deg, #fff8e1 0%, #ffe082 100%)';
          card.style.borderColor = '#FFD700';
        }
        
        card.onclick = (e) => {
          console.log(`🖱️ ${index + 1}번째 카드 클릭:`, user.name);
          e.preventDefault();
          e.stopPropagation();
          login(user.name);
        };
        
        card.ontouchend = (e) => {
          console.log(`👆 ${index + 1}번째 카드 터치:`, user.name);
          e.preventDefault();
          login(user.name);
        };
        
        const avatar = document.createElement('div');
        avatar.className = 'user-card-avatar';
        avatar.textContent = user.name.charAt(0);
        
        // 🆕 관리자 아바타 스타일
        if (user.isAdmin) {
          avatar.style.background = '#FFD700';
          avatar.style.color = 'white';
        }
        
        const name = document.createElement('div');
        name.className = 'user-card-name';
        name.textContent = user.name;
        
        // 🆕 관리자 배지 추가
        if (user.isAdmin) {
          const adminBadge = document.createElement('span');
          adminBadge.style.cssText = 'font-size: 11px; color: #F57C00; margin-left: 4px;';
          adminBadge.textContent = '👑';
          name.appendChild(adminBadge);
        }
        
        card.appendChild(avatar);
        card.appendChild(name);
        grid.appendChild(card);
      });
      
      console.log('✅ 사용자 카드 렌더링 완료');
    }
    
    window.addNewUser = function() {
      const input = document.getElementById('newUserInput');
      const name = input.value.trim();
      if (!name) {
        alert('사용자 이름을 입력하세요.');
        return;
      }
      if (assignees.some(a => a.name === name)) {
        alert('이미 존재하는 사용자입니다.');
        return;
      }
      const assigneesRef = window.dbRef(window.db, `companies/${currentCompanyId}/assignees`);
      const newAssigneeRef = window.dbPush(assigneesRef);
      window.dbSet(newAssigneeRef, {
        name: name
      });
      input.value = '';
    };
    
    window.login = function(userName) {
      console.log('🎯 로그인 시도:', userName);
      
      currentUser = userName;
      
      // 🆕 사용자 ID와 관리자 여부 확인
      const userEntry = assignees.find(a => a.name === userName);
      if (userEntry) {
        currentUserId = userEntry.id;
        isAdmin = userEntry.isAdmin || false;
        console.log('👤 사용자 정보:', { 
          name: userName, 
          id: currentUserId, 
          isAdmin: isAdmin 
        });
      }

      // ✅ 1단계: showMainApp 함수를 먼저 독립적으로 정의
      function showMainApp() {
        console.log('📱 메인 앱 표시');
        
        // 로그인 화면 숨기기
        const loginContainer = document.getElementById('loginContainer');
        loginContainer.style.display = 'none';
        loginContainer.style.visibility = 'hidden';
        loginContainer.style.opacity = '0';
        
        // 앱 컨테이너 표시
        const appContainer = document.getElementById('appContainer');
        appContainer.style.display = 'flex';
        appContainer.classList.add('active');
        
        console.log('✅ 화면 전환 완료');
        
        document.getElementById('userAvatar').textContent = currentUser.charAt(0);
        document.getElementById('headerUserName').textContent = currentUser;
        
        // 관리자 표시
        if (isAdmin) {
          document.getElementById('headerUserName').innerHTML = 
            `${currentUser} <span style="color: #FFD700; font-size: 11px;">👑 관리자</span>`;
        }
        
        updateDateDisplay();
        loadWorks();
        loadSites();
        loadAllCompaniesWorks();
        renderMenu();
        
        setTimeout(() => {
          console.log('🗺️ 지도 초기화 시작...');
          initMap();
        }, 500);
        
        console.log('✅ 메인 앱 로드 완료');
      }
      
      // ✅ 2단계: login 함수를 간단하게 정의 (중복 제거)
      window.login = function(userName) {
        console.log('🎯 로그인 시도:', userName);
        
        currentUser = userName;
        
        // 사용자 ID와 관리자 여부 확인
        const userEntry = assignees.find(a => a.name === userName);
        if (userEntry) {
          currentUserId = userEntry.id;
          isAdmin = userEntry.isAdmin || false;
          console.log('👤 사용자 정보:', { 
            name: userName, 
            id: currentUserId, 
            isAdmin: isAdmin 
          });
        }
        
        // 회사 정보 로드
        loadCompanyInfo();
        
        // ✅ showMainApp() 호출 (이제 위에서 정의했으므로 사용 가능!)
        showMainApp();
        
        console.log('✅ 로그인 완료');
      };
  
      // ✅ 2단계: login 함수를 간단하게 만드세요!
      window.login = function(userName) {
        console.log('🎯 로그인 시도:', userName);
        
        currentUser = userName;
        
        // 사용자 ID와 관리자 여부 확인
        const userEntry = assignees.find(a => a.name === userName);
        if (userEntry) {
          currentUserId = userEntry.id;
          isAdmin = userEntry.isAdmin || false;
          console.log('👤 사용자 정보:', { 
            name: userName, 
            id: currentUserId, 
            isAdmin: isAdmin 
          });
        }
        
        // 회사 정보 로드
        loadCompanyInfo();
        
        // ✅ showMainApp() 호출 (이제 위에서 정의했으므로 사용 가능!)
        showMainApp();
        
        console.log('✅ 로그인 완료');
      };
    
    // 🆕 회사 정보 로드 함수
    function loadCompanyInfo() {
      const companyRef = window.dbRef(window.db, `companies/${currentCompanyId}/info`);
      window.dbOnValue(companyRef, (snapshot) => {
        companyInfo = snapshot.val();
        console.log('🏢 회사 정보 로드:', companyInfo);
      });
    }
    
    window.logout = function() {
      console.log('🚪 로그아웃 시작');
      
      // 현재 사용자와 회사 정보 초기화
      currentUser = null;
      currentCompanyId = null;  /* 🆕 추가: 회사 정보도 초기화 */
      
      // 앱 컨테이너 완전히 숨기기
      const appContainer = document.getElementById('appContainer');
      appContainer.classList.remove('active');
      appContainer.style.display = 'none';
      
      // 로그인 컨테이너 표시
      const loginContainer = document.getElementById('loginContainer');
      loginContainer.style.display = 'flex';
      loginContainer.style.visibility = 'visible';
      loginContainer.style.opacity = '1';
      
      // 🆕 회사 로그인 화면으로 이동 (처음 화면)
      document.getElementById('companyLoginStep').style.display = 'block';
      document.getElementById('createCompanyStep').style.display = 'none';
      document.getElementById('userSelectStep').style.display = 'none';
      
      // 🆕 비밀번호 입력란만 초기화 (아이디는 유지)
      document.getElementById('companyPasswordInput').value = '';
      
      console.log('✅ 로그아웃 완료 - 회사 로그인 화면으로 이동');
    };

    // 🆕 회사 탈퇴 기능
    window.deleteCompany = async function() {
      console.log('⚠️ 회사 탈퇴 시도');
      
      // 🆕 관리자 권한 확인
      if (!isAdmin) {
        alert('회사 탈퇴는 관리자만 할 수 있습니다.');
        return;
      }
      
      // 메뉴 닫기
      toggleMenu();
      
      // 1단계: 경고 메시지
      const confirmMessage = `⚠️ 회사 탈퇴 경고 ⚠️\n\n` +
        `회사를 탈퇴하면 다음 데이터가 모두 삭제됩니다:\n` +
        `• 모든 작업 내역\n` +
        `• 모든 현장 정보\n` +
        `• 모든 사용자 정보 (${assignees.length}명)\n` +  // 🆕 직원 수 표시
        `• 회사 정보\n\n` +
        `이 작업은 되돌릴 수 없습니다!\n\n` +
        `정말로 탈퇴하시겠습니까?`;
        `• 모든 작업 내역\n` +
        `• 모든 현장 정보\n` +
        `• 모든 사용자 정보\n` +
        `• 회사 정보\n\n` +
        `이 작업은 되돌릴 수 없습니다!\n\n` +
        `정말로 탈퇴하시겠습니까?`;
      
      if (!confirm(confirmMessage)) {
        console.log('❌ 회사 탈퇴 취소됨');
        return;
      }
      
      // 2단계: 비밀번호 확인
      const password = prompt('회사 비밀번호를 입력하여 탈퇴를 확인하세요:');
      
      if (!password) {
        alert('탈퇴가 취소되었습니다.');
        console.log('❌ 비밀번호 입력 취소됨');
        return;
      }
      
      try {
        // Firebase에서 회사 정보 가져오기
        const companyRef = window.dbRef(window.db, `companies/${currentCompanyId}/info`);
        
        window.dbOnValue(companyRef, async (snapshot) => {
          const companyInfo = snapshot.val();
          
          if (!companyInfo) {
            alert('회사 정보를 찾을 수 없습니다.');
            return;
          }
          
          // 비밀번호 확인
          if (companyInfo.password !== password) {
            alert('비밀번호가 일치하지 않습니다.');
            console.log('❌ 비밀번호 불일치');
            return;
          }
          
          // 3단계: 최종 확인
          const finalConfirm = confirm(
            '⚠️ 최종 확인 ⚠️\n\n' +
            '지금 확인을 누르면 회사가 영구적으로 삭제됩니다.\n' +
            '정말로 진행하시겠습니까?'
          );
          
          if (!finalConfirm) {
            alert('탈퇴가 취소되었습니다.');
            console.log('❌ 최종 확인 취소됨');
            return;
          }
          
          // 회사 데이터 삭제
          const companyDataRef = window.dbRef(window.db, `companies/${currentCompanyId}`);
          
          window.dbRemove(companyDataRef).then(() => {
            console.log('✅ 회사 데이터 삭제 완료');
            
            // 자동 로그인 정보 삭제
            clearAutoLogin();
            
            alert(
              '회사 탈퇴가 완료되었습니다.\n\n' +
              '모든 데이터가 삭제되었습니다.\n' +
              '이용해 주셔서 감사합니다.'
            );
            
            // 로그아웃 처리
            currentUser = null;
            currentCompanyId = null;
            
            // 앱 컨테이너 숨기기
            const appContainer = document.getElementById('appContainer');
            appContainer.classList.remove('active');
            appContainer.style.display = 'none';
            
            // 로그인 화면 표시
            const loginContainer = document.getElementById('loginContainer');
            loginContainer.style.display = 'flex';
            loginContainer.style.visibility = 'visible';
            loginContainer.style.opacity = '1';
            
            // 회사 로그인 화면으로 이동
            document.getElementById('companyLoginStep').style.display = 'block';
            document.getElementById('createCompanyStep').style.display = 'none';
            document.getElementById('userSelectStep').style.display = 'none';
            
            // 입력 필드 초기화
            document.getElementById('companyIdInput').value = '';
            document.getElementById('companyPasswordInput').value = '';
            
            console.log('✅ 회사 탈퇴 완료 - 로그인 화면으로 이동');
            
          }).catch((error) => {
            console.error('❌ 회사 삭제 중 오류:', error);
            alert('회사 탈퇴 중 오류가 발생했습니다: ' + error.message);
          });
          
        }, { onlyOnce: true });
        
      } catch (error) {
        console.error('❌ 회사 탈퇴 처리 중 오류:', error);
        alert('회사 탈퇴 처리 중 오류가 발생했습니다: ' + error.message);
      }
    };    
    window.goToToday = function() {
      currentDate = new Date();
      updateDateDisplay();
      renderWorks();
    };
    
    window.changeDate = function(days) {
      currentDate.setDate(currentDate.getDate() + days);
      updateDateDisplay();
      renderWorks();
    };

    function updateDateDisplay() {
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'short'
      };
      document.getElementById('dateDisplay').textContent = currentDate.toLocaleDateString('ko-KR', options);
    }
    
    window.addWork = function() {
      const site = document.getElementById('siteInput').value.trim();
      const work = document.getElementById('workInput').value.trim();
      if (!site || !work) {
        alert('현장명과 작업 내용을 입력하세요.');
        return;
      }
      const worksRef = window.dbRef(window.db, `companies/${currentCompanyId}/works`);
      const todayStr = currentDate.toISOString().split('T')[0];
      const newWorkRef = window.dbPush(worksRef);
      const parentWorkId = newWorkRef.key;
      window.dbSet(newWorkRef, {
        date: todayStr,
        site: site,
        work: work,
        displayWork: work,
        assignee: currentUser,
        completed: false,
        createdAt: new Date().toISOString(),
        deadline: work === '시험' ? null : todayStr,
        order: Date.now()
      });
      if (work === '시험') {
        const testDateStr = todayStr;
        const cappingDate = addBusinessDays(testDateStr, 1);
        const cappingRef = window.dbPush(worksRef);
        window.dbSet(cappingRef, {
          date: cappingDate,
          site: site,
          work: '캡핑',
          displayWork: '캡핑',
          assignee: currentUser,
          completed: false,
          createdAt: new Date().toISOString(),
          parentWorkId: parentWorkId,
          testDate: testDateStr
        });
        const demoldingDate = addBusinessDays(testDateStr, 2);
        const demoldingRef = window.dbPush(worksRef);
        window.dbSet(demoldingRef, {
          date: demoldingDate,
          site: site,
          work: '탈형',
          displayWork: '탈형',
          assignee: currentUser,
          completed: false,
          createdAt: new Date().toISOString(),
          parentWorkId: parentWorkId,
          testDate: testDateStr
        });
        const day7Date = addCalendarDays(testDateStr, 7);
        const day7Ref = window.dbPush(worksRef);
        window.dbSet(day7Ref, {
          date: day7Date,
          site: site,
          work: '7일 강도 시험',
          displayWork: '7일 강도 시험',
          assignee: currentUser,
          completed: false,
          createdAt: new Date().toISOString(),
          parentWorkId: parentWorkId,
          testDate: testDateStr
        });
        const day28Date = addCalendarDays(testDateStr, 28);
        const day28Ref = window.dbPush(worksRef);
        window.dbSet(day28Ref, {
          date: day28Date,
          site: site,
          work: '28일 강도 시험',
          displayWork: '28일 강도 시험',
          assignee: currentUser,
          completed: false,
          createdAt: new Date().toISOString(),
          parentWorkId: parentWorkId,
          testDate: testDateStr
        });
      }
      document.getElementById('siteInput').value = '';
      document.getElementById('workInput').value = '';
    };
    
    function loadWorks() {
      console.log('📋 작업 데이터 로드 중...');
      
      if (!currentCompanyId) {
        console.error('❌ currentCompanyId가 설정되지 않음');
        return;
      }
      
      const worksRef = window.dbRef(window.db, `companies/${currentCompanyId}/works`);
      window.dbOnValue(worksRef, (snapshot) => {
        works = snapshot.val() || {};
        console.log('✅ 작업 데이터 로드 완료:', Object.keys(works).length, '개');
        renderWorks();
      });
    }
    
    function loadSites() {
      const sitesRef = window.dbRef(window.db, `companies/${currentCompanyId}/sites`);
      window.dbOnValue(sitesRef, (snapshot) => {
        sites = snapshot.val() || {};
        renderSiteList();
      });
    }

    function renderWorks() {
      if (isDraggingNow) {
        console.log('⚠️ 드래그 중 - 렌더링 건너뜀');
        return;
      }
      const searchDate = currentDate.toISOString().split('T')[0];
      const myWorks = [];
      const teamWorks = [];
      const completedWorks = [];
      
      // 🆕 다른 회사의 작업 정보를 먼저 수집
      const otherCompaniesWorkMap = {};
      
      Object.keys(works).forEach(workId => {
        const work = works[workId];
        let shouldShow = false;
        if (work.completed) {
          const deadline = work.deadline || work.date;
          const isOverdue = work.completedDate && deadline < work.completedDate;
          completedWorks.push({
            ...work,
            id: workId,
            displayWork: work.displayWork || work.work,
            isOverdue: isOverdue
          });
          return;
        }
        if (work.work === '시험' || work.parentWorkId) {
          shouldShow = work.date === searchDate;
        } else {
          shouldShow = work.date <= searchDate;
        }
        if (shouldShow) {
          const deadline = work.deadline || work.date;
          const isOverdue = deadline < searchDate;
          
          // 🆕 다른 회사의 같은 현장 작업 찾기
          const otherCompanyInfo = [];
          if (work.site) {
            // allCompaniesWorks에서 같은 날짜, 같은 현장 찾기
            Object.keys(allCompaniesWorks).forEach(companyId => {
              if (companyId === currentCompanyId) return; // 자기 회사는 제외
              
              const companyWorks = allCompaniesWorks[companyId].works || {};
              const companyName = allCompaniesWorks[companyId].name || companyId;
              
              Object.values(companyWorks).forEach(otherWork => {
                if (otherWork.completed) return;
                
                // 🆕 현장명과 주소를 함께 비교 (80% 이상 유사도)
                // 내 회사의 현장 정보 가져오기
                const mySite = Object.values(sites).find(s => s.name === work.site);
                const mySiteAddress = mySite ? mySite.address : '';
                
                // 다른 회사의 현장 정보 가져오기
                const otherCompanySites = allCompaniesWorks[companyId].sites || {};
                const otherSite = Object.values(otherCompanySites).find(s => s.name === otherWork.site);
                const otherSiteAddress = otherSite ? otherSite.address : '';
                
                // 유사도 비교
                if (!areSitesSimilar(work.site, mySiteAddress, otherWork.site, otherSiteAddress)) {
                  return;
                }
                
                let otherShouldShow = false;
                if (otherWork.work === '시험' || otherWork.parentWorkId) {
                  otherShouldShow = otherWork.date === searchDate;
                } else {
                  otherShouldShow = otherWork.date <= searchDate;
                }
                
                if (otherShouldShow) {
                  otherCompanyInfo.push({
                    companyName: companyName,
                    assignee: otherWork.assignee || '미정'
                  });
                }
              });
            });
          }
          
          const visibleWork = {
            ...work,
            id: workId,
            displayWork: work.displayWork || work.work,
            isOverdue: isOverdue,
            otherCompanyInfo: otherCompanyInfo  // 🆕 추가
          };
          if (work.assignee === currentUser) {
            myWorks.push(visibleWork);
          } else {
            teamWorks.push(visibleWork);
          }
        }
      });
      completedWorks.sort((a, b) => {
        const dateA = a.completedDate || a.date;
        const dateB = b.completedDate || b.date;
        return dateB.localeCompare(dateA);
      });
      const container = document.getElementById('taskContainer');
      container.innerHTML = '';
      const myActiveWorks = myWorks.filter(w => !w.completed);
      
      myActiveWorks.sort((a, b) => {
        const orderA = typeof a.order === 'number' ? a.order : 999;
        const orderB = typeof b.order === 'number' ? b.order : 999;
        if (orderA === orderB) {
          return a.id.localeCompare(b.id);
        }
        return orderA - orderB;
      });
      
      if (myActiveWorks.length > 0) {
        const header = document.createElement('div');
        header.className = 'section-header my-work' + (sectionStates.myActive ? '' : ' collapsed');
        header.innerHTML = '<span class="section-toggle">▼</span> 📌 내 작업 진행 중 <span style="color: #2a459c; font-weight: 700;">(' + myActiveWorks.length + ')</span>';
        header.onclick = () => toggleSection('myActive');
        container.appendChild(header);
        const grid = document.createElement('div');
        grid.className = 'task-grid' + (sectionStates.myActive ? '' : ' collapsed');
        grid.id = 'myTaskGrid';
        
        myActiveWorks.forEach((work, index) => {
          work.orderNumber = index + 1;
          grid.appendChild(createWorkCard(work, false));
        });
        container.appendChild(grid);
        
        grid.addEventListener('dragover', handleDragOver);
        grid.addEventListener('drop', handleDrop);
      }
      const teamActiveWorks = teamWorks.filter(w => !w.completed);
      if (teamActiveWorks.length > 0) {
        if (myActiveWorks.length > 0) {
          const divider = document.createElement('div');
          divider.className = 'section-divider';
          container.appendChild(divider);
        }
        const header = document.createElement('div');
        header.className = 'section-header' + (sectionStates.teamActive ? '' : ' collapsed');
        header.innerHTML = '<span class="section-toggle">▼</span> 👥 팀 작업 진행 중 <span style="color: #666; font-weight: 700;">(' + teamActiveWorks.length + ')</span>';
        header.onclick = () => toggleSection('teamActive');
        container.appendChild(header);
        const grid = document.createElement('div');
        grid.className = 'task-grid' + (sectionStates.teamActive ? '' : ' collapsed');
        grid.id = 'teamTaskGrid';
        teamActiveWorks.forEach(work => {
          grid.appendChild(createWorkCard(work, false));
        });
        container.appendChild(grid);
      }
      if (completedWorks.length > 0) {
        if (myWorks.length > 0 || teamWorks.length > 0) {
          const divider = document.createElement('div');
          divider.className = 'section-divider';
          container.appendChild(divider);
        }
        const header = document.createElement('div');
        header.className = 'section-header' + (sectionStates.completed ? '' : ' collapsed');
        header.innerHTML = `<span class="section-toggle">▼</span> ✅ 완료됨 <span style="color: #4caf50; font-weight: 700;">(${completedWorks.length})</span>`;
        header.onclick = () => toggleSection('completed');
        container.appendChild(header);
        const grid = document.createElement('div');
        grid.className = 'task-grid' + (sectionStates.completed ? '' : ' collapsed');
        grid.id = 'completedTaskGrid';
        grid.style.maxHeight = '400px';
        grid.style.overflowY = 'auto';
        completedWorks.forEach(work => {
          grid.appendChild(createWorkCard(work, true));
        });
        container.appendChild(grid);
      }
      if (myWorks.length === 0 && teamWorks.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
          <div class="empty-icon">📋</div>
          <div>이 날짜에 예정된 작업이 없습니다</div>
        `;
        container.appendChild(emptyState);
      }
    }
    
    function toggleSection(sectionKey) {
      sectionStates[sectionKey] = !sectionStates[sectionKey];
      renderWorks();
    }
    
    function createWorkCard(work, isCompleted) {
      const card = document.createElement('div');
      card.className = 'task-card' + (isCompleted ? ' completed' : '');
      if (!isCompleted && work.isOverdue) {
        card.classList.add('overdue');
      }
      
      if (work.assignee === currentUser && !isCompleted) {
        card.draggable = true;
      } else {
        card.draggable = false;
      }
      
      card.dataset.workId = work.id;
      if (work.assignee === currentUser) {
        card.classList.add('my-task');
      }
      
      if (!isCompleted) {
        // 터치/드래그 변수 통합
        let touchStartX = 0;
        let touchStartY = 0;
        let touchCurrentX = 0;
        let touchCurrentY = 0;
        let isDragging = false;
        let isSwiping = false;
        let dragStarted = false;
        let touchStartOrder = [];
        
        // 🆕 모바일: 터치 시작
        card.addEventListener('touchstart', (e) => {
          if (e.target.closest('.task-checkbox') || 
              e.target.closest('.assignee-select') || 
              e.target.closest('.action-btn') ||
              e.target.closest('.deadline-label-container')) {
            return;
          }
          
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          isDragging = false;
          isSwiping = false;
          
          const grid = card.closest('.task-grid');
          if (grid) {
            touchStartOrder = Array.from(grid.querySelectorAll('.task-card')).map(c => c.dataset.workId);
          }
        }, { passive: true });
        
        // 🆕 모바일: 터치 이동
        // 🟢 수정 후
        card.addEventListener('touchmove', (e) => {
          if (e.target.closest('.task-checkbox') || 
              e.target.closest('.assignee-select') || 
              e.target.closest('.action-btn') ||
              e.target.closest('.deadline-label-container')) {
            return;
          }
          
          touchCurrentX = e.touches[0].clientX;
          touchCurrentY = e.touches[0].clientY;
          const deltaX = touchStartX - touchCurrentX;
          const deltaY = Math.abs(touchCurrentY - touchStartY);
          
          // 수평/수직 이동 구분
          if (!isDragging && !isSwiping) {
            if (Math.abs(deltaX) > 10 && Math.abs(deltaX) > deltaY) {
              isSwiping = true;
            } else if (deltaY > 10 && deltaY > Math.abs(deltaX)) {
              isDragging = true;
              card.classList.add('dragging');
              document.body.classList.add('dragging-active');
            }
          }
          
          // 슬라이드 처리
          if (isSwiping) {
            e.preventDefault();
            // 🆕 왼쪽으로만 슬라이드 가능, 최대 50px
            if (deltaX > 0 && deltaX <= 50) {
              card.style.transform = `translateX(-${deltaX}px)`;
            } else if (deltaX > 50) {
              card.style.transform = `translateX(-50px)`;  // 최대치 고정
            }
            return;
          }
          
          // 드래그 처리
          if (isDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            const originalVisibility = card.style.visibility;
            card.style.visibility = 'hidden';
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            card.style.visibility = originalVisibility;
            
            const targetCard = elementBelow?.closest('.task-card');
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over'));
            
            if (targetCard && targetCard !== card && !targetCard.classList.contains('completed')) {
              targetCard.classList.add('drag-over');
              
              const container = card.closest('.task-grid');
              const targetContainer = targetCard.closest('.task-grid');
              
              if (container && targetContainer && container === targetContainer && container.id === 'myTaskGrid') {
                const rect = targetCard.getBoundingClientRect();
                const touchY = touch.clientY;
                const middle = rect.top + rect.height / 2;
                
                if (touchY < middle) {
                  container.insertBefore(card, targetCard);
                } else {
                  const nextCard = targetCard.nextElementSibling;
                  if (nextCard && nextCard !== card) {
                    container.insertBefore(card, nextCard);
                  } else {
                    container.appendChild(card);
                  }
                }
              }
            }
          }
        }, { passive: false });
        
        // 🆕 모바일: 터치 종료
        card.addEventListener('touchend', (e) => {
          document.body.classList.remove('dragging-active');
          
          // 슬라이드 처리
          if (isSwiping) {
            const deltaX = touchStartX - touchCurrentX;
            
            // 🆕 25px 이상 슬라이드하면 삭제 버튼 표시 (더 민감하게)
            if (deltaX > 25) {
              card.classList.add('swiped-left');
              // CSS의 transform이 처리하므로 여기서는 제거
              card.style.transform = '';
            } else {
              card.classList.remove('swiped-left');
              card.style.transform = '';
            }
            
            // 🆕 햅틱 피드백 추가
            if (deltaX > 25 && navigator.vibrate) {
              navigator.vibrate(30);
            }
            
            isSwiping = false;
            isDragging = false;
            card.classList.remove('dragging');
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over'));
            return;
          }
          
          // 드래그 처리
          if (!isDragging) {
            card.classList.remove('dragging');
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over'));
            return;
          }
          
          const grid = card.closest('.task-grid');
          if (grid && grid.id === 'myTaskGrid') {
            const cards = Array.from(grid.querySelectorAll('.task-card'));
            const currentOrder = cards.map(c => c.dataset.workId);
            
            const hasChanged = !touchStartOrder.every((id, index) => id === currentOrder[index]);
            
            if (!hasChanged) {
              card.classList.remove('dragging');
              document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over'));
              isDragging = false;
              return;
            }
            
            const updates = {};
            cards.forEach((c, index) => {
              const workId = c.dataset.workId;
              if (workId && works[workId]) {
                updates[`works/${workId}/order`] = index;
                works[workId].order = index;
              }
            });
            
            window.dbUpdate(window.dbRef(window.db), updates).then(() => {
              renderWorks();
              
              if (isRouteDisplayed && currentPosition) {
                const searchDate = currentDate.toISOString().split('T')[0];
                const myActiveWorks = [];
                Object.keys(works).forEach(workId => {
                  const work = works[workId];
                  if (work.completed) return;
                  if (work.assignee !== currentUser) return;
                  let shouldShow = false;
                  if (work.work === '시험' || work.parentWorkId) {
                    shouldShow = work.date === searchDate;
                  } else {
                    shouldShow = work.date <= searchDate;
                  }
                  if (shouldShow) {
                    myActiveWorks.push(work);
                  }
                });
                
                myActiveWorks.sort((a, b) => {
                  const orderA = typeof a.order === 'number' ? a.order : 999;
                  const orderB = typeof b.order === 'number' ? b.order : 999;
                  if (orderA === orderB) {
                    return a.id.localeCompare(b.id);
                  }
                  return orderA - orderB;
                });
                
                if (myActiveWorks.length > 0) {
                  drawRouteFromCurrentLocation(currentPosition, myActiveWorks);
                }
              }
            });
            
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
          }
          
          card.classList.remove('dragging');
          document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over'));
          isDragging = false;
        }, { passive: false });
        
        card.addEventListener('touchcancel', (e) => {
          document.body.classList.remove('dragging-active');
          card.classList.remove('dragging');
          document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over'));
          isDragging = false;
          isSwiping = false;
        });
        
        // 다른 카드 터치 시 슬라이드 상태 초기화
        document.addEventListener('touchstart', function resetSwipe(e) {
          if (!e.target.closest('.task-card')) {
            document.querySelectorAll('.task-card.swiped-left').forEach(c => {
              c.classList.remove('swiped-left');
              c.style.transform = '';  // 🆕 CSS가 처리하도록
            });
          } else if (e.target.closest('.task-card') !== card) {
            card.classList.remove('swiped-left');
            card.style.transform = '';  // 🆕 CSS가 처리하도록
          }
        });
        
        // PC: 마우스 다운
        card.addEventListener('mousedown', (e) => {
          if (e.target.closest('.task-checkbox') || 
              e.target.closest('.assignee-select') || 
              e.target.closest('.action-btn') ||
              e.target.closest('.deadline-label-container')) {
            return;
          }
          touchStartX = e.clientX;
          touchStartY = e.clientY;
          dragStarted = false;
        });
        
        // PC: 마우스 이동
        card.addEventListener('mousemove', (e) => {
          if (e.buttons === 1) {
            const deltaX = Math.abs(e.clientX - touchStartX);
            const deltaY = Math.abs(e.clientY - touchStartY);
            if (deltaX > 5 || deltaY > 5) {
              dragStarted = true;
            }
          }
        });
        
        // PC: 클릭 (드래그와 구분)
        card.addEventListener('click', (e) => {
          if (e.target.closest('.task-checkbox') || 
              e.target.closest('.assignee-select') || 
              e.target.closest('.action-btn') ||
              e.target.closest('.deadline-label-container')) {
            return;
          }
          
          if (dragStarted) {
            dragStarted = false;
            return;
          }
          
          document.querySelectorAll('.task-card.selected').forEach(c => {
            if (c !== card) c.classList.remove('selected');
          });
          
          card.classList.toggle('selected');
        });
        
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        
        // 번호와 체크박스 컨테이너
        const numberCheckContainer = document.createElement('div');
        numberCheckContainer.className = 'number-check-container';
        
        if (work.orderNumber) {
          const orderNum = document.createElement('div');
          orderNum.className = 'order-number';
          orderNum.textContent = work.orderNumber;
          numberCheckContainer.appendChild(orderNum);
        }
        
        const checkbox = document.createElement('div');
        checkbox.className = 'task-checkbox';
        checkbox.onclick = (e) => {
          e.stopPropagation();
          toggleComplete(work.id);
        };
        numberCheckContainer.appendChild(checkbox);
        
        card.appendChild(numberCheckContainer);
      } else {
        // 🆕 완료된 작업에도 체크박스 추가 (완료 취소용)
        const completedCheckContainer = document.createElement('div');
        completedCheckContainer.className = 'number-check-container';
        
        const checkbox = document.createElement('div');
        checkbox.className = 'task-checkbox';
        checkbox.style.cursor = 'pointer';
        checkbox.onclick = (e) => {
          e.stopPropagation();
          // 완료 취소 확인
          if (confirm('이 작업을 다시 진행중으로 되돌리시겠습니까?')) {
            toggleComplete(work.id);
          }
        };
        completedCheckContainer.appendChild(checkbox);
        
        card.appendChild(completedCheckContainer);
      }
      
      const cardBody = document.createElement('div');
      cardBody.className = 'task-card-body';
      
      const title = document.createElement('div');
      title.className = 'task-title';
      title.textContent = `${work.site} - ${work.displayWork}`;
      if (!isCompleted && work.isOverdue) {
        const warningBadge = document.createElement('span');
        warningBadge.className = 'overdue-warning';
        warningBadge.textContent = '⚠️ 기한초과';
        title.appendChild(document.createTextNode(' '));
        title.appendChild(warningBadge);
      }
      cardBody.appendChild(title);
      
      // 완료 기한 또는 작업등록일자
      if (work.work !== '시험' && !work.parentWorkId) {
        const deadlineContainer = document.createElement('div');
        deadlineContainer.className = 'deadline-label-container';
        deadlineContainer.onclick = (e) => {
          e.stopPropagation();
          if (!isCompleted) {
            openDeadlineModal(work.id, work.deadline || work.date);
          }
        };
        const deadlineLabel = document.createElement('span');
        deadlineLabel.className = 'deadline-label-text';
        deadlineLabel.textContent = '완료 기한:';
        const deadlineDate = document.createElement('span');
        deadlineDate.className = 'deadline-date-tag';
        if (!isCompleted && work.isOverdue) {
          deadlineDate.classList.add('overdue');
        }
        deadlineDate.textContent = work.deadline || work.date;
        deadlineContainer.appendChild(deadlineLabel);
        deadlineContainer.appendChild(deadlineDate);
        cardBody.appendChild(deadlineContainer);
      }
      
      if (work.testDate) {
        const dateContainer = document.createElement('div');
        dateContainer.className = 'deadline-label-container';
        dateContainer.style.cursor = 'pointer';
        dateContainer.onclick = (e) => {
          e.stopPropagation();
          showTimeline(work);
        };
        
        const dateLabel = document.createElement('span');
        dateLabel.className = 'deadline-label-text';
        dateLabel.textContent = '작업등록일자:';
        
        const testDateTag = document.createElement('span');
        testDateTag.className = 'test-date-label';
        testDateTag.textContent = work.testDate;
        
        dateContainer.appendChild(dateLabel);
        dateContainer.appendChild(testDateTag);
        cardBody.appendChild(dateContainer);
      }
      
      if (isCompleted && work.completedDate) {
        const completedInfo = document.createElement('div');
        completedInfo.style.cssText = 'margin-top: 6px; font-size: 11px; color: #4caf50;';
        const completedLabel = document.createElement('span');
        completedLabel.textContent = '✓ 완료: ';
        completedLabel.style.fontWeight = '600';
        const completedDate = document.createElement('span');
        completedDate.textContent = work.completedDate;
        const completedBy = document.createElement('span');
        completedBy.textContent = ` (담당: ${work.assignee || '미정'})`;
        completedBy.style.color = '#666';
        completedInfo.appendChild(completedLabel);
        completedInfo.appendChild(completedDate);
        completedInfo.appendChild(completedBy);
        cardBody.appendChild(completedInfo);
      }
      
      // 왼쪽 영역 추가
      card.appendChild(cardBody);

      // 🆕 가운데 영역: 다른 회사 정보 (cardBody 밖으로!)
      // 🆕 가운데 영역: 다른 회사 정보 (cardBody 밖으로!)
      if (work.otherCompanyInfo && work.otherCompanyInfo.length > 0) {
        const otherCompaniesSection = document.createElement('div');
        otherCompaniesSection.className = 'other-companies-section';
        
        work.otherCompanyInfo.forEach(info => {
          const badge = document.createElement('div');
          badge.className = 'other-company-badge';
          
          // 🟢 회사명 라인 (아이콘 제거)
          const nameLine = document.createElement('div');
          nameLine.className = 'other-company-name-line';
          nameLine.innerHTML = `
            <span class="other-company-name">${info.companyName}</span>
          `;
          
          // 🟢 담당자 라인 (아이콘 제거)
          const assigneeLine = document.createElement('div');
          assigneeLine.className = 'other-company-assignee-line';
          assigneeLine.innerHTML = `
            <span class="other-company-assignee">${info.assignee}</span>
          `;
          
          badge.appendChild(nameLine);
          badge.appendChild(assigneeLine);
          otherCompaniesSection.appendChild(badge);
        });
        
        card.appendChild(otherCompaniesSection);
      }
      
      // 오른쪽 영역: 담당자 선택
      const personContainer = document.createElement('div');
      personContainer.className = 'person-select-container';
      const assigneeWrapper = document.createElement('div');
      assigneeWrapper.className = 'select-wrapper';
      const assigneeLabel = document.createElement('label');
      assigneeLabel.className = 'select-label';
      assigneeLabel.textContent = '담당자';
      const assigneeSelect = document.createElement('select');
      assigneeSelect.className = 'assignee-select';
      assigneeSelect.onclick = (e) => e.stopPropagation();
      if (isCompleted) assigneeSelect.disabled = true;
      const assigneeDefaultOption = document.createElement('option');
      assigneeDefaultOption.value = '';
      assigneeDefaultOption.textContent = '선택';
      assigneeSelect.appendChild(assigneeDefaultOption);
      assignees.forEach(assignee => {
        const option = document.createElement('option');
        option.value = assignee.name;
        option.textContent = assignee.name;
        if (work.assignee === assignee.name) {
          option.selected = true;
        }
        assigneeSelect.appendChild(option);
      });
      if (!isCompleted) {
        assigneeSelect.onchange = () => saveAssignee(work.id, assigneeSelect.value);
      }
      assigneeWrapper.appendChild(assigneeLabel);
      assigneeWrapper.appendChild(assigneeSelect);
      personContainer.appendChild(assigneeWrapper);
      card.appendChild(personContainer);
      
      // 삭제 버튼
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'action-btn';
      deleteBtn.textContent = '🗑️';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteWork(work.id);
      };
      card.appendChild(deleteBtn);
      
      return card;
    }
    
    function handleDragStart(e) {
      draggedElement = this;
      draggedWorkId = this.dataset.workId;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      
      isDraggingNow = true;
      const grid = this.closest('.task-grid');
      if (grid) {
        originalOrder = Array.from(grid.querySelectorAll('.task-card')).map(card => card.dataset.workId);
      }
      console.log('🟢 드래그 시작 - 원래 순서:', originalOrder);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      const grid = this.closest('.task-grid');
      if (grid && grid.id === 'myTaskGrid') {
        const cards = Array.from(grid.querySelectorAll('.task-card'));
        const currentOrder = cards.map(card => card.dataset.workId);
        
        const hasChanged = !originalOrder.every((id, index) => id === currentOrder[index]);
        console.log('🔴 드래그 종료');
        console.log('   원래 순서:', originalOrder);
        console.log('   현재 순서:', currentOrder);
        console.log('   변경됨?', hasChanged);
        
        if (!hasChanged) {
          console.log('❌ 순서 변경 없음 - 저장 안 함');
          isDraggingNow = false;
          return;
        }
        
        const updates = {};
        cards.forEach((card, index) => {
          const workId = card.dataset.workId;
          if (workId && works[workId]) {
            updates[`works/${workId}/order`] = index;
            works[workId].order = index;
          }
        });
        
        window.dbUpdate(window.dbRef(window.db), updates).then(() => {
          console.log('✅ 순서 저장 완료!');
          isDraggingNow = false;
          renderWorks();
          
          if (isRouteDisplayed && currentPosition) {
            console.log('🔄 경로 자동 업데이트');
            const searchDate = currentDate.toISOString().split('T')[0];
            const myActiveWorks = [];
            Object.keys(works).forEach(workId => {
              const work = works[workId];
              if (work.completed) return;
              if (work.assignee !== currentUser) return;
              let shouldShow = false;
              if (work.work === '시험' || work.parentWorkId) {
                shouldShow = work.date === searchDate;
              } else {
                shouldShow = work.date <= searchDate;
              }
              if (shouldShow) {
                myActiveWorks.push(work);
              }
            });
            
            myActiveWorks.sort((a, b) => {
              const orderA = typeof a.order === 'number' ? a.order : 999;
              const orderB = typeof b.order === 'number' ? b.order : 999;
              if (orderA === orderB) {
                return a.id.localeCompare(b.id);
              }
              return orderA - orderB;
            });
            
            if (myActiveWorks.length > 0) {
              drawRouteFromCurrentLocation(currentPosition, myActiveWorks);
            }
          }
        }).catch(() => {
          isDraggingNow = false;
        });
      } else {
        isDraggingNow = false;
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      const draggedCard = document.querySelector('.dragging');
      if (!draggedCard) return;
      
      const targetCard = e.target.closest('.task-card');
      if (!targetCard || targetCard === draggedCard) return;
      if (targetCard.classList.contains('completed')) return;
      
      const container = draggedCard.closest('.task-grid');
      const targetContainer = targetCard.closest('.task-grid');
      if (!container || !targetContainer || container !== targetContainer) return;
      if (container.id !== 'myTaskGrid') return;
      
      const rect = targetCard.getBoundingClientRect();
      const mouseY = e.clientY;
      const middle = rect.top + rect.height / 2;
      
      if (mouseY < middle) {
        container.insertBefore(draggedCard, targetCard);
      } else {
        const nextCard = targetCard.nextElementSibling;
        if (nextCard && nextCard !== draggedCard) {
          container.insertBefore(draggedCard, nextCard);
        } else {
          container.appendChild(draggedCard);
        }
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
    
    function showTimeline(work) {
      const modal = document.getElementById('timelineModal');
      const title = document.getElementById('timelineTitle');
      const content = document.getElementById('timelineContent');
      title.textContent = `${work.site} - 시험 타임라인`;
      content.innerHTML = '';
      const parentId = work.parentWorkId || work.id;
      const parentWork = works[parentId];
      if (!parentWork) return;
      const timeline = [{
        work: '시험',
        date: parentWork.date,
        id: parentId,
        completed: parentWork.completed
      }];
      Object.keys(works).forEach(id => {
        if (works[id].parentWorkId === parentId) {
          timeline.push({
            work: works[id].work,
            date: works[id].date,
            id: id,
            completed: works[id].completed
          });
        }
      });
      timeline.sort((a, b) => a.date.localeCompare(b.date));
      timeline.forEach(item => {
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item';
        if (item.id === work.id) {
          timelineItem.classList.add('active');
        }
        const workDiv = document.createElement('div');
        workDiv.className = 'timeline-work';
        workDiv.textContent = `${item.completed ? '✓ ' : ''}${item.work}`;
        if (item.completed) {
          workDiv.style.textDecoration = 'line-through';
          workDiv.style.color = '#999';
        }
        const dateDiv = document.createElement('div');
        dateDiv.className = 'timeline-date';
        dateDiv.textContent = item.date;
        timelineItem.appendChild(workDiv);
        timelineItem.appendChild(dateDiv);
        content.appendChild(timelineItem);
      });
      modal.classList.add('active');
    }
    
    window.closeTimelineModal = function() {
      document.getElementById('timelineModal').classList.remove('active');
    };
    
    // 🟢 수정 후
    function toggleComplete(workId) {
      const work = works[workId];
      if (!work) return;
      
      const workRef = window.dbRef(window.db, `companies/${currentCompanyId}/works/${workId}`);
      const isCompleting = !work.completed;
      
      const updateData = {
        completed: isCompleting
      };
      
      if (isCompleting) {
        // 완료 처리
        updateData.completedDate = new Date().toISOString().split('T')[0];
        
        // 🆕 햅틱 피드백 (완료 시)
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      } else {
        // 완료 취소
        updateData.completedDate = null;
        
        // 🆕 햅틱 피드백 (취소 시)
        if (navigator.vibrate) {
          navigator.vibrate([30, 50, 30]);  // 패턴 진동
        }
        
        // 🆕 완료 취소 시 order 값 복원 (맨 아래로)
        updateData.order = Date.now();
      }
      
      window.dbUpdate(workRef, updateData);
    }
    
    function saveAssignee(workId, assignee) {
      const workRef = window.dbRef(window.db, `companies/${currentCompanyId}/works/${workId}`);
      window.dbUpdate(workRef, {
        assignee: assignee
      });
    }
    
    function deleteWork(workId) {
      const work = works[workId];
      if (!work) return;
      if (work.work === '시험') {
        if (!confirm('이 시험 작업과 관련된 모든 작업(캡핑, 탈형, 7일강도, 28일강도)을 삭제하시겠습니까?')) return;
        Object.keys(works).forEach(id => {
          if (works[id].parentWorkId === workId) {
            const childWorkRef = window.dbRef(window.db, `works/${id}`);
            window.dbRemove(childWorkRef);
          }
        });
      } else {
        if (!confirm('이 작업을 삭제하시겠습니까?')) return;
      }
      const workRef = window.dbRef(window.db, `companies/${currentCompanyId}/works/${workId}`);
      window.dbRemove(workRef);
    }
    
    // ✅ 이렇게 수정
    window.toggleSiteModal = function() {
      const modal = document.getElementById('siteModal');
      
      // 🆕 모달 닫을 때 수정 모드 해제
      if (modal.classList.contains('active')) {
        cancelEditSite();
      }
      
      modal.classList.toggle('active');
      if (modal.classList.contains('active')) {
        renderSiteList();
      }
    };
    
    window.toggleSiteSelectModal = function() {
      const modal = document.getElementById('siteSelectModal');
      modal.classList.toggle('active');
      if (modal.classList.contains('active')) {
        renderSiteSelectList();
      }
    };

    function renderSiteList() {
      const list = document.getElementById('siteList');
      list.innerHTML = '';
      Object.keys(sites).forEach(id => {
        const site = sites[id];
        const li = document.createElement('li');
        li.className = 'site-item';
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'site-item-info';
        
        const name = document.createElement('div');
        name.className = 'site-item-name';
        name.textContent = site.name;
        
        const address = document.createElement('div');
        address.className = 'site-item-address';
        address.textContent = site.address || '주소 없음';
        
        infoDiv.appendChild(name);
        infoDiv.appendChild(address);
        
        // 🆕 버튼 컨테이너
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'site-item-actions';
        
        // 🆕 수정 버튼
        const editBtn = document.createElement('button');
        editBtn.className = 'site-item-edit';
        editBtn.textContent = '수정';
        editBtn.onclick = () => editSite(id, site.name, site.address);
        
        // 삭제 버튼
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'site-item-delete';
        deleteBtn.textContent = '삭제';
        deleteBtn.onclick = () => deleteSite(id);
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        
        li.appendChild(infoDiv);
        li.appendChild(actionsDiv);
        list.appendChild(li);
      });
    }

    function renderSiteSelectList() {
      const list = document.getElementById('siteSelectList');
      list.innerHTML = '';
      Object.keys(sites).forEach(id => {
        const site = sites[id];
        const li = document.createElement('li');
        li.className = 'site-item';
        li.onclick = () => selectSite(site.name);
        const name = document.createElement('span');
        name.className = 'site-item-name';
        name.textContent = site.name;
        li.appendChild(name);
        list.appendChild(li);
      });
    }

    function selectSite(siteName) {
      document.getElementById('siteInput').value = siteName;
      toggleSiteSelectModal();
    }
    
    // 🆕 현장 저장/수정 통합 함수
    window.saveSite = function() {
      const nameInput = document.getElementById('newSiteName');
      const addressInput = document.getElementById('newSiteAddress');
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      
      if (!name) {
        alert('현장명을 입력하세요.');
        return;
      }
      if (!address) {
        alert('주소를 입력하세요.');
        return;
      }
      
      if (currentEditingSiteId) {
        // 🆕 수정 모드
        console.log('✅ 현장 수정:', currentEditingSiteId);
        
        // 1️⃣ 기존 현장명 가져오기
        const oldSite = sites[currentEditingSiteId];
        const oldSiteName = oldSite ? oldSite.name : '';
        
        console.log(`🔄 현장명 변경: "${oldSiteName}" → "${name}"`);
        
        // 2️⃣ 현장 정보 업데이트
        const siteRef = window.dbRef(window.db, `companies/${currentCompanyId}/sites/${currentEditingSiteId}`);
        window.dbUpdate(siteRef, {
          name: name,
          address: address,
          updatedAt: new Date().toISOString()
        }).then(() => {
          
          // 3️⃣ 현장명이 변경된 경우에만 작업들도 업데이트
          if (oldSiteName !== name) {
            console.log('📋 현장명이 변경되어 관련 작업들을 업데이트합니다...');
            
            // 해당 현장을 사용하는 모든 작업 찾기
            const updates = {};
            let updatedCount = 0;
            
            Object.keys(works).forEach(workId => {
              const work = works[workId];
              
              // 🆕 유사도 비교 (80% 이상 유사하면 같은 현장으로 간주)
              const oldSiteObj = Object.values(sites).find(s => s.name === oldSiteName);
              const oldSiteAddress = oldSiteObj ? oldSiteObj.address : '';
              
              const workSiteObj = Object.values(sites).find(s => s.name === work.site);
              const workSiteAddress = workSiteObj ? workSiteObj.address : '';
              
              // 현장명과 주소를 함께 비교
              if (areSitesSimilar(oldSiteName, oldSiteAddress, work.site, workSiteAddress)) {
                updates[`companies/${currentCompanyId}/works/${workId}/site`] = name;
                works[workId].site = name; // 로컬 데이터도 업데이트
                updatedCount++;
                console.log(`  ✅ 작업 업데이트: ${workId} - "${work.work}"`);
              }
            });
            
            // Firebase 일괄 업데이트
            if (updatedCount > 0) {
              window.dbUpdate(window.dbRef(window.db), updates).then(() => {
                alert(`현장이 수정되었습니다.\n관련 작업 ${updatedCount}개도 함께 업데이트되었습니다.`);
                cancelEditSite();
                renderWorks(); // 작업 목록 새로고침
              }).catch((error) => {
                alert('작업 업데이트 중 오류가 발생했습니다: ' + error.message);
              });
            } else {
              alert('현장이 수정되었습니다.');
              cancelEditSite();
            }
            
          } else {
            // 현장명은 변경 안 되고 주소만 변경된 경우
            alert('현장 정보가 수정되었습니다.');
            cancelEditSite();
          }
          
        }).catch((error) => {
          alert('현장 수정 중 오류가 발생했습니다: ' + error.message);
        });
        
      } else {
        // 기존 추가 모드
        console.log('✅ 현장 추가');
        
        const sitesRef = window.dbRef(window.db, `companies/${currentCompanyId}/sites`);
        const newSiteRef = window.dbPush(sitesRef);
        window.dbSet(newSiteRef, {
          name: name,
          address: address,
          createdAt: new Date().toISOString()
        }).then(() => {
          nameInput.value = '';
          addressInput.value = '';
          alert('현장이 추가되었습니다.');
        }).catch((error) => {
          alert('현장 추가 중 오류가 발생했습니다: ' + error.message);
        });
      }
    };
    

    function deleteSite(id) {
      if (!confirm('이 현장을 삭제하시겠습니까?')) return;
      const siteRef = window.dbRef(window.db, `companies/${currentCompanyId}/sites/${id}`);
      window.dbRemove(siteRef);
    }

    // 🆕 현장 수정 모드로 전환
    window.editSite = function(siteId, siteName, siteAddress) {
      console.log('✏️ 현장 수정 시작:', siteId);
      
      currentEditingSiteId = siteId;
      
      // 입력 필드에 기존 값 채우기
      document.getElementById('newSiteName').value = siteName;
      document.getElementById('newSiteAddress').value = siteAddress;
      
      // 모달 제목 변경
      document.getElementById('siteModalTitle').textContent = '현장 수정';
      
      // 저장 버튼 텍스트 변경
      document.getElementById('saveSiteBtn').textContent = '수정 완료';
      
      // 취소 버튼 표시
      document.getElementById('cancelEditBtn').style.display = 'block';
      
      // 입력 필드에 포커스
      document.getElementById('newSiteName').focus();
    };    

    // ✅ editSite 함수 다음에 바로 추가
    // 🆕 현장 수정 취소
    window.cancelEditSite = function() {
      console.log('❌ 현장 수정 취소');
      
      currentEditingSiteId = null;
      
      // 입력 필드 초기화
      document.getElementById('newSiteName').value = '';
      document.getElementById('newSiteAddress').value = '';
      
      // 모달 제목 복원
      document.getElementById('siteModalTitle').textContent = '현장 추가';
      
      // 저장 버튼 텍스트 복원
      document.getElementById('saveSiteBtn').textContent = '저장';
      
      // 취소 버튼 숨기기
      document.getElementById('cancelEditBtn').style.display = 'none';
    };
    
    function calculateBusinessDays(startDate, endDate) {
      if (startDate > endDate) return -1;
      let count = 0;
      let curDate = new Date(startDate.getTime());
      while (curDate < endDate) {
        const dayOfWeek = curDate.getDay();
        if (dayOfWeek != 0 && dayOfWeek != 6) count++;
        curDate.setDate(curDate.getDate() + 1);
      }
      return count;
    }

    function calculateAbsoluteDays(startDate, endDate) {
      const oneDay = 24 * 60 * 60 * 1000;
      const diffDays = Math.round((endDate - startDate) / oneDay);
      return diffDays;
    }

    function addBusinessDays(startDate, businessDays) {
      const date = new Date(startDate);
      let count = 0;
      while (count < businessDays) {
        date.setDate(date.getDate() + 1);
        if (date.getDay() !== 0 && date.getDay() !== 6) {
          count++;
        }
      }
      return date.toISOString().split('T')[0];
    }

    function addCalendarDays(startDate, days) {
      const date = new Date(startDate);
      date.setDate(date.getDate() + days);
      return date.toISOString().split('T')[0];
    }
    
    document.getElementById('timelineModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('timelineModal')) {
        closeTimelineModal();
      }
    });
    document.getElementById('siteModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('siteModal')) {
        toggleSiteModal();
      }
    });
    document.getElementById('siteSelectModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('siteSelectModal')) {
        toggleSiteSelectModal();
      }
    });

    document.getElementById('companyIdInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('companyPasswordInput').focus();
      }
    });
    
    document.getElementById('companyPasswordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loginCompany();
      }
    });
    
    document.getElementById('newCompanyIdInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('newCompanyPasswordInput').focus();
      }
    });
    
    document.getElementById('newCompanyPasswordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('confirmPasswordInput').focus();
      }
    });
    
    document.getElementById('confirmPasswordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        createCompany();
      }
    });

        
    document.getElementById('siteInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('workInput').focus();
      }
    });
    document.getElementById('workInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addWork();
    });
    document.getElementById('newUserInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addNewUser();
    });
    document.getElementById('newSiteName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') saveSite();  // ✅ addSite → saveSite
    });
    
    let currentEditingWorkId = null;

    function openDeadlineModal(workId, currentDeadline) {
      currentEditingWorkId = workId;
      const modal = document.getElementById('deadlineModal');
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const friday = new Date(today);
      const day = today.getDay();
      const diff = (5 - day + 7) % 7;
      friday.setDate(friday.getDate() + (diff === 0 ? 7 : diff));
      document.getElementById('todayDate').textContent = today.toISOString().split('T')[0];
      document.getElementById('tomorrowDate').textContent = tomorrow.toISOString().split('T')[0];
      document.getElementById('thisWeekDate').textContent = friday.toISOString().split('T')[0];
      document.getElementById('customDeadlineInput').value = currentDeadline;
      modal.classList.add('active');
    }
    
    window.selectDeadline = function(option) {
      if (!currentEditingWorkId) return;
      let selectedDate;
      const today = new Date();
      switch (option) {
        case 'today':
          selectedDate = today.toISOString().split('T')[0];
          break;
        case 'tomorrow':
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          selectedDate = tomorrow.toISOString().split('T')[0];
          break;
        case 'thisWeek':
          const friday = new Date(today);
          const day = today.getDay();
          const diff = (5 - day + 7) % 7;
          friday.setDate(friday.getDate() + (diff === 0 ? 7 : diff));
          selectedDate = friday.toISOString().split('T')[0];
          break;
        case 'custom':
          selectedDate = document.getElementById('customDeadlineInput').value;
          if (!selectedDate) {
            alert('날짜를 선택하세요.');
            return;
          }
          break;
      }
      // ✅ 올바른 경로: companies/${currentCompanyId}/works/${workId}
      const workRef = window.dbRef(window.db, `companies/${currentCompanyId}/works/${currentEditingWorkId}`);
      window.dbUpdate(workRef, {
        deadline: selectedDate
      });
      document.getElementById('deadlineModal').classList.remove('active');
      currentEditingWorkId = null;
    };
    
    document.getElementById('deadlineModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('deadlineModal')) {
        document.getElementById('deadlineModal').classList.remove('active');
        currentEditingWorkId = null;
      }
    });

    // 🆕 메뉴 렌더링 (관리자 여부에 따라)
    function renderMenu() {
      const adminSection = document.getElementById('adminMenuSection');
      
      if (adminSection) {
        if (isAdmin) {
          adminSection.style.display = 'block';
          console.log('✅ 관리자 메뉴 표시');
        } else {
          adminSection.style.display = 'none';
          console.log('ℹ️ 일반 사용자 - 관리자 메뉴 숨김');
        }
      }
    }
    
// 🆕 메뉴 토글 (햄버거 애니메이션 포함)
    window.toggleMenu = function() {
      const menu = document.getElementById('menuDropdown');
      const menuBtn = document.querySelector('.menu-btn');
      const overlay = document.getElementById('menuOverlay');
      
      const isActive = menu.classList.contains('active');
      
      if (isActive) {
        // 메뉴 닫기
        menu.classList.remove('active');
        menuBtn.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
      } else {
        // 메뉴 열기
        menu.classList.add('active');
        menuBtn.classList.add('active');
        if (overlay) overlay.classList.add('active');
      }
    };
    
    // 메뉴 외부 클릭 시 닫기
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('menuDropdown');
      const menuBtn = document.querySelector('.menu-btn');
      
      if (menu && menuBtn) {
        if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
          menu.classList.remove('active');
          menuBtn.classList.remove('active');
          const overlay = document.getElementById('menuOverlay');
          if (overlay) overlay.classList.remove('active');
        }
      }
    });
    
    // 🆕 사용설명서 모달 토글
    window.toggleGuideModal = function() {
      const modal = document.getElementById('guideModal');
      modal.classList.toggle('active');
    };

    // 🆕 회사 코드 모달 토글
    window.toggleCompanyCodeModal = function() {
      const modal = document.getElementById('companyCodeModal');
      
      if (!modal.classList.contains('active')) {
        // 모달 열 때 회사 코드 표시
        if (companyInfo && companyInfo.companyCode) {
          document.getElementById('displayCompanyCode').textContent = companyInfo.companyCode;
        }
      }
      
      modal.classList.toggle('active');
    };

    // 🆕 회사 코드 복사
    window.copyCompanyCode = function() {
      if (!companyInfo || !companyInfo.companyCode) {
        alert('회사 코드를 불러올 수 없습니다.');
        return;
      }
      
      const code = companyInfo.companyCode;
      
      // 클립보드 복사
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          alert(`회사 코드가 복사되었습니다!\n\n코드: ${code}\n\n이 코드를 직원들에게 공유하세요.`);
          
          // 햅틱 피드백
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
        }).catch(err => {
          // 폴백: 텍스트 영역 사용
          fallbackCopy(code);
        });
      } else {
        fallbackCopy(code);
      }
    };

    // 🆕 직원 목록 렌더링
    function renderStaffList() {
      const list = document.getElementById('staffList');
      const countSpan = document.getElementById('staffCount');
      
      if (!list) return;
      
      list.innerHTML = '';
      
      // 관리자를 제외한 직원 수
      const staffCount = assignees.filter(a => !a.isAdmin).length;
      countSpan.textContent = assignees.length;
      
      assignees.forEach(user => {
        const li = document.createElement('li');
        li.className = 'site-item';
        
        // 관리자 배경색
        if (user.isAdmin) {
          li.style.background = 'linear-gradient(135deg, #fff8e1 0%, #ffe082 100%)';
          li.style.borderLeft = '4px solid #FFD700';
        }
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'site-item-info';
        
        const name = document.createElement('div');
        name.className = 'site-item-name';
        name.textContent = user.name;
        
        // 관리자 배지
        if (user.isAdmin) {
          const badge = document.createElement('span');
          badge.style.cssText = 'margin-left: 8px; font-size: 12px; color: #F57C00; font-weight: 600;';
          badge.textContent = '👑 관리자';
          name.appendChild(badge);
        }
        
        const role = document.createElement('div');
        role.className = 'site-item-address';
        role.textContent = user.isAdmin ? '모든 권한 보유' : '일반 직원';
        
        infoDiv.appendChild(name);
        infoDiv.appendChild(role);
        
        // 삭제 버튼 (관리자는 삭제 불가)
        if (!user.isAdmin) {
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'site-item-actions';
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'site-item-delete';
          deleteBtn.textContent = '퇴출';
          deleteBtn.onclick = () => removeStaff(user.id, user.name);
          
          actionsDiv.appendChild(deleteBtn);
          li.appendChild(infoDiv);
          li.appendChild(actionsDiv);
        } else {
          li.appendChild(infoDiv);
        }
        
        list.appendChild(li);
      });
      
      if (assignees.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">등록된 직원이 없습니다.</p>';
      }
    }
    
    // 🆕 직원 강제 퇴출
    window.removeStaff = function(userId, userName) {
      if (!isAdmin) {
        alert('관리자만 사용할 수 있습니다.');
        return;
      }
      
      const confirmMsg = 
        `⚠️ 직원 퇴출 확인 ⚠️\n\n` +
        `직원: ${userName}\n\n` +
        `이 직원을 퇴출하면:\n` +
        `• 더 이상 로그인할 수 없습니다\n` +
        `• 담당했던 작업은 유지됩니다\n\n` +
        `정말로 퇴출하시겠습니까?`;
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      // Firebase에서 삭제
      const assigneeRef = window.dbRef(window.db, `companies/${currentCompanyId}/assignees/${userId}`);
      window.dbRemove(assigneeRef).then(() => {
        alert(`${userName}님이 퇴출되었습니다.`);
        console.log('✅ 직원 퇴출 완료:', userName);
        
        // 목록 새로고침은 Firebase 리스너가 자동으로 처리
      }).catch((error) => {
        alert('직원 퇴출 중 오류가 발생했습니다: ' + error.message);
        console.error('❌ 직원 퇴출 실패:', error);
      });
    };

    // 🆕 회사 정보 저장
    window.saveCompanyInfo = function() {
      if (!isAdmin) {
        alert('관리자만 사용할 수 있습니다.');
        return;
      }
      
      const newCompanyName = document.getElementById('editCompanyName').value.trim();
      const currentPassword = document.getElementById('currentPasswordForEdit').value;
      const newPassword = document.getElementById('newPasswordForEdit').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      
      // 회사명 확인
      if (!newCompanyName) {
        alert('회사명을 입력하세요.');
        return;
      }
      
      // 현재 비밀번호 확인
      if (!currentPassword) {
        alert('현재 비밀번호를 입력하세요.');
        return;
      }
      
      if (!companyInfo || companyInfo.password !== currentPassword) {
        alert('현재 비밀번호가 일치하지 않습니다.');
        return;
      }
      
      // 새 비밀번호 검증 (입력한 경우에만)
      if (newPassword) {
        if (newPassword.length < 4) {
          alert('새 비밀번호는 최소 4자 이상이어야 합니다.');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          alert('새 비밀번호가 일치하지 않습니다.');
          return;
        }
      }
      
      // 업데이트할 데이터
      const updates = {
        name: newCompanyName,
        updatedAt: new Date().toISOString()
      };
      
      // 비밀번호 변경 시
      if (newPassword) {
        updates.password = newPassword;
      }
      
      const companyInfoRef = window.dbRef(window.db, `companies/${currentCompanyId}/info`);
      window.dbUpdate(companyInfoRef, updates).then(() => {
        let message = '회사 정보가 수정되었습니다.';
        
        if (newPassword) {
          message += '\n\n비밀번호도 변경되었습니다.';
          
          // 🆕 자동 로그인 정보 업데이트
          if (localStorage.getItem('autoLogin') === 'true') {
            localStorage.setItem('savedPassword', newPassword);
          }
        }
        
        alert(message);
        
        // 모달 닫기
        toggleCompanyInfoModal();
        
        console.log('✅ 회사 정보 수정 완료');
      }).catch((error) => {
        alert('회사 정보 수정 중 오류가 발생했습니다: ' + error.message);
        console.error('❌ 회사 정보 수정 실패:', error);
      });
    };

    // 🆕 권한 이전 대상 목록 렌더링
    function renderTransferAdminList() {
      const select = document.getElementById('newAdminSelect');
      
      if (!select) return;
      
      // 초기화
      select.innerHTML = '<option value="">선택하세요</option>';
      
      // 본인을 제외한 다른 직원들만 표시
      assignees.forEach(user => {
        if (user.id !== currentUserId && !user.isAdmin) {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.name;
          select.appendChild(option);
        }
      });
      
      if (assignees.length <= 1) {
        select.innerHTML = '<option value="">권한을 이전할 직원이 없습니다</option>';
        select.disabled = true;
      } else {
        select.disabled = false;
      }
    }
    
    // 🆕 관리자 권한 이전
    window.transferAdmin = function() {
      if (!isAdmin) {
        alert('관리자만 사용할 수 있습니다.');
        return;
      }
      
      const newAdminId = document.getElementById('newAdminSelect').value;
      const password = document.getElementById('passwordForTransfer').value;
      
      if (!newAdminId) {
        alert('새 관리자를 선택하세요.');
        return;
      }
      
      if (!password) {
        alert('비밀번호를 입력하세요.');
        return;
      }
      
      if (!companyInfo || companyInfo.password !== password) {
        alert('비밀번호가 일치하지 않습니다.');
        return;
      }
      
      const newAdmin = assignees.find(a => a.id === newAdminId);
      
      if (!newAdmin) {
        alert('선택한 직원을 찾을 수 없습니다.');
        return;
      }
      
      const finalConfirm = confirm(
        `⚠️ 최종 확인 ⚠️\n\n` +
        `새 관리자: ${newAdmin.name}\n\n` +
        `권한을 이전하면:\n` +
        `• ${newAdmin.name}님이 새 관리자가 됩니다\n` +
        `• 본인(${currentUser})은 일반 직원이 됩니다\n` +
        `• 이 작업은 되돌릴 수 없습니다\n\n` +
        `정말로 진행하시겠습니까?`
      );
      
      if (!finalConfirm) {
        return;
      }
      
      // Firebase 업데이트
      const updates = {};
      
      // 1. 회사 정보에 새 관리자 ID 저장
      updates[`companies/${currentCompanyId}/info/adminId`] = newAdminId;
      
      // 2. 새 관리자에게 isAdmin 플래그 추가
      updates[`companies/${currentCompanyId}/assignees/${newAdminId}/isAdmin`] = true;
      
      // 3. 기존 관리자(본인)의 isAdmin 플래그 제거
      updates[`companies/${currentCompanyId}/assignees/${currentUserId}/isAdmin`] = false;
      
      window.dbUpdate(window.dbRef(window.db), updates).then(() => {
        alert(
          `권한 이전이 완료되었습니다!\n\n` +
          `새 관리자: ${newAdmin.name}\n\n` +
          `앱을 다시 시작합니다.`
        );
        
        // 로그아웃 처리
        logout();
        
        console.log('✅ 관리자 권한 이전 완료:', newAdmin.name);
      }).catch((error) => {
        alert('권한 이전 중 오류가 발생했습니다: ' + error.message);
        console.error('❌ 권한 이전 실패:', error);
      });
    };

    
    // 폴백 복사 방법
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        document.execCommand('copy');
        alert(`회사 코드가 복사되었습니다!\n\n코드: ${text}\n\n이 코드를 직원들에게 공유하세요.`);
      } catch (err) {
        alert(`코드를 복사할 수 없습니다.\n\n수동으로 복사하세요: ${text}`);
      }
      
      document.body.removeChild(textArea);
    }
    
    // 🆕 회사 코드 재발급
    window.regenerateCompanyCode = function() {
      if (!isAdmin) {
        alert('관리자만 사용할 수 있습니다.');
        return;
      }
      
      const confirmMsg = 
        '⚠️ 회사 코드 재발급 경고 ⚠️\n\n' +
        '코드를 재발급하면:\n' +
        '• 기존 코드는 사용할 수 없습니다\n' +
        '• 새로운 직원은 새 코드로만 가입 가능합니다\n' +
        '• 기존 직원에게는 영향이 없습니다\n\n' +
        '정말로 재발급하시겠습니까?';
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      const password = prompt('비밀번호를 입력하여 확인하세요:');
      
      if (!password) {
        alert('재발급이 취소되었습니다.');
        return;
      }
      
      if (!companyInfo || companyInfo.password !== password) {
        alert('비밀번호가 일치하지 않습니다.');
        return;
      }
      
      // 새 코드 생성
      const newCode = generateCompanyCode();
      
      const companyInfoRef = window.dbRef(window.db, `companies/${currentCompanyId}/info`);
      window.dbUpdate(companyInfoRef, {
        companyCode: newCode,
        codeUpdatedAt: new Date().toISOString()
      }).then(() => {
        alert(`회사 코드가 재발급되었습니다!\n\n새 코드: ${newCode}\n\n새로운 코드를 직원들에게 공유하세요.`);
        
        // 화면 업데이트
        document.getElementById('displayCompanyCode').textContent = newCode;
        
        console.log('✅ 회사 코드 재발급 완료:', newCode);
      }).catch((error) => {
        alert('코드 재발급 중 오류가 발생했습니다: ' + error.message);
        console.error('❌ 코드 재발급 실패:', error);
      });
    };
    
    // 🆕 직원 관리 모달 토글
    window.toggleStaffManageModal = function() {
      const modal = document.getElementById('staffManageModal');
      
      if (!modal.classList.contains('active')) {
        // 모달 열 때 직원 목록 렌더링
        renderStaffList();
      }
      
      modal.classList.toggle('active');
    };
    
    // 🆕 회사 정보 수정 모달 토글
    window.toggleCompanyInfoModal = function() {
      const modal = document.getElementById('companyInfoModal');
      
      if (!modal.classList.contains('active')) {
        // 모달 열 때 현재 정보 채우기
        if (companyInfo) {
          document.getElementById('editCompanyName').value = companyInfo.name || '';
        }
        // 비밀번호 필드 초기화
        document.getElementById('currentPasswordForEdit').value = '';
        document.getElementById('newPasswordForEdit').value = '';
        document.getElementById('confirmNewPassword').value = '';
      }
      
      modal.classList.toggle('active');
    };
    
    // 🆕 관리자 권한 이전 모달 토글
    window.toggleTransferAdminModal = function() {
      const modal = document.getElementById('transferAdminModal');
      
      if (!modal.classList.contains('active')) {
        // 모달 열 때 직원 목록 채우기
        renderTransferAdminList();
        document.getElementById('passwordForTransfer').value = '';
      }
      
      modal.classList.toggle('active');
    };
    
    // 모달 외부 클릭 시 닫기
    document.addEventListener('DOMContentLoaded', function() {
      const modals = [
        'companyCodeModal',
        'staffManageModal', 
        'companyInfoModal',
        'transferAdminModal'
      ];
      
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.remove('active');
            }
          });
        }
      });
    });
    
    //회사코드 확인 모달
    <div class="modal-overlay" id="companyCodeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">🔑 회사 코드</h3>
          <button class="close-btn" onclick="toggleCompanyCodeModal()">×</button>
        </div>
        
        <div style="text-align: center; padding: 30px 20px;">
          <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
            직원 초대 시 이 코드를 공유하세요
          </p>
          
          <div style="
            background: linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%);
            border: 3px dashed #2a459c;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
          ">
            <div style="font-size: 36px; font-weight: 700; color: #2a459c; letter-spacing: 4px; font-family: 'Courier New', monospace;" id="displayCompanyCode">
              ------
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="admin-btn" onclick="copyCompanyCode()" style="flex: 1; max-width: 200px;">
              📋 복사하기
            </button>
            <button class="admin-btn" onclick="regenerateCompanyCode()" style="flex: 1; max-width: 200px; background: #ff9800;">
              🔄 코드 재발급
            </button>
          </div>
          
          <p style="font-size: 12px; color: #999; margin-top: 20px;">
            💡 코드를 재발급하면 기존 코드는 사용할 수 없습니다
          </p>
        </div>
      </div>
    </div>
    
    <!-- 🆕 직원 관리 모달 -->
    <div class="modal-overlay" id="staffManageModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">👥 직원 관리</h3>
          <button class="close-btn" onclick="toggleStaffManageModal()">×</button>
        </div>
        
        <div style="padding: 10px 0;">
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 14px; color: #666; margin-bottom: 12px; font-weight: 600;">
              현재 직원 목록 (<span id="staffCount">0</span>명)
            </h4>
            <ul class="site-list" id="staffList"></ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 🆕 회사 정보 수정 모달 -->
    <div class="modal-overlay" id="companyInfoModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">🏢 회사 정보 수정</h3>
          <button class="close-btn" onclick="toggleCompanyInfoModal()">×</button>
        </div>
        
        <div style="padding: 10px 0;">
          <div class="input-group">
            <label class="input-label">회사명</label>
            <input type="text" class="admin-input" id="editCompanyName" placeholder="회사명">
          </div>
          
          <div class="input-group">
            <label class="input-label">현재 비밀번호</label>
            <input type="password" class="admin-input" id="currentPasswordForEdit" placeholder="현재 비밀번호">
            <div class="input-hint">변경하려면 현재 비밀번호를 입력하세요</div>
          </div>
          
          <div class="input-group">
            <label class="input-label">새 비밀번호 (선택)</label>
            <input type="password" class="admin-input" id="newPasswordForEdit" placeholder="변경할 비밀번호">
            <div class="input-hint">변경하지 않으려면 비워두세요</div>
          </div>
          
          <div class="input-group">
            <label class="input-label">새 비밀번호 확인</label>
            <input type="password" class="admin-input" id="confirmNewPassword" placeholder="비밀번호 재입력">
          </div>
          
          <button class="admin-btn" onclick="saveCompanyInfo()">💾 저장</button>
        </div>
      </div>
    </div>
    
    <!-- 🆕 관리자 권한 이전 모달 -->
    <div class="modal-overlay" id="transferAdminModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">🔄 관리자 권한 이전</h3>
          <button class="close-btn" onclick="toggleTransferAdminModal()">×</button>
        </div>
        
        <div style="padding: 10px 0;">
          <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
            <p style="font-size: 13px; color: #e65100; line-height: 1.6;">
              ⚠️ <strong>주의:</strong> 관리자 권한을 이전하면 본인은 일반 직원이 됩니다. 이 작업은 되돌릴 수 없습니다.
            </p>
          </div>
          
          <div class="input-group">
            <label class="input-label">새 관리자 선택</label>
            <select class="admin-input" id="newAdminSelect">
              <option value="">선택하세요</option>
            </select>
          </div>
          
          <div class="input-group">
            <label class="input-label">비밀번호 확인</label>
            <input type="password" class="admin-input" id="passwordForTransfer" placeholder="현재 비밀번호">
            <div class="input-hint">권한 이전을 확인하기 위해 비밀번호를 입력하세요</div>
          </div>
          
          <button class="admin-btn" onclick="transferAdmin()" style="background: #ff9800;">
            🔄 권한 이전
          </button>
        </div>
      </div>
    </div>
    
    // 사용설명서 모달 외부 클릭 시 닫기
    document.getElementById('guideModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('guideModal')) {
        toggleGuideModal();
      }
    });    
    
    window.onload = function() {
      waitForFirebase();
    };
  </script>
</body>

</html>
